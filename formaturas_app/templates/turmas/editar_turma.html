{% extends 'base.html' %} {% block content %}
<!-- Área de exibição e edição do nome da Turma -->
<div id="displayTurma" class="turma-display">
  <h2>
    <span id="nomeTurmaDisplay" class="turma-name-display"
      >{{ turma_atual }}</span
    >
    <a
      href="javascript:void(0);"
      id="btnToggleEdit"
      title="Editar"
      class="btn-editar btn-editar-left"
    ></a>
  </h2>
</div>
<div id="editarNomeTurma" class="turma-edit">
  <form method="post" id="formRenomearTurma">
    <input
      type="text"
      name="nova_turma"
      id="novaTurma"
      required
      placeholder="Novo nome da Turma"
    />
    <button type="button" class="btn btn-voltar" id="btnCancelarEdicao">
      Cancelar
    </button>
    <button type="submit" class="btn">Renomear</button>
  </form>
</div>

<!-- Sumário e opção de ordenação -->
{% set total_parentes = 0 %} {% set total_fotos = 0 %} {% for a in alunos %} {%
set total_parentes = total_parentes + a.parentes|length %} {% set total_fotos =
total_fotos + (a.parentes | selectattr('comprou_foto') | list | length) %} {%
endfor %}
<div class="turmas-summary">
  Alunos: <span id="total-alunos">{{ alunos|length }}</span> | Parentes:
  <span id="total-parentes">{{ total_parentes }}</span> | Fotos Compradas:
  <span id="total-fotos">{{ total_fotos }}</span>
</div>
<div class="sorting">
  <button id="orderToggle" data-order="asc" class="btn">Ordenar A-Z</button>
</div>

<!-- Tabela com a lista de alunos -->
<div class="table-responsive">
  <table class="table">
    <thead>
      <tr>
        <th>Aluno</th>
        <th style="text-align: right">Ações</th>
      </tr>
    </thead>
    <tbody id="alunosBody">
      {% for a in alunos %}
      <tr
        class="student-row"
        data-student-id="{{ a.id }}"
        data-student-name="{{ a.aluno|lower }}"
      >
        <td>
          <span class="student-name">{{ a.aluno }}</span><br />
          {% set fotos_count = a.parentes | selectattr('comprou_foto') | list |
          length %}
          <small
            class="parente-count"
            id="parente-count-{{ a.id }}"
            data-count="{{ a.parentes|length }}"
            data-fotos="{{ fotos_count }}"
          >
            {{ a.parentes|length }} parente(s) | Fotos Compradas: {{ fotos_count
            }}
          </small>
        </td>
        <td style="text-align: right">
          <span class="toggle-icon"></span>
          <a
            href="{{ url_for('turmas.excluir_aluno', id=a.id, active_page='turmas') }}"
            class="btn-excluir btn-delete-aluno"
            data-student-id="{{ a.id }}"
            title="Excluir"
          ></a>
        </td>
      </tr>
      <tr class="parentes-row" data-student-id="{{ a.id }}">
        <td colspan="2">
          <div class="parentes-container" id="parentes-container-{{ a.id }}">
            <p>Carregando parentes...</p>
          </div>
          <button
            class="btn"
            onclick="abrirModalParente('{{ a.id }}'); event.stopPropagation();"
          >
            + Adicionar parente
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Botões adicionais -->
<div class="editar-turma-buttons">
  <a
    href="{{ url_for('turmas.index', active_page='turmas') }}"
    class="btn btn-voltar"
    >← Turmas</a
  >
  <button type="button" class="btn" id="btnAbrirFormAluno">
    Adicionar novo aluno
  </button>
</div>
<div id="formNovoAluno" class="novo-aluno-form">
  <form
    method="post"
    action="{{ url_for('turmas.adicionar_aluno', turma=turma_atual, active_page='turmas') }}"
    id="novoAlunoForm"
  >
    <div class="form-group">
      <label for="aluno">Nome do aluno</label>
      <input
        type="text"
        id="aluno"
        name="aluno"
        required
        placeholder="Digite o nome do aluno"
      />
    </div>
    <div class="form-group">
      <button type="button" class="btn btn-voltar" id="btnCancelarAluno">
        Cancelar
      </button>
      <button type="submit" class="btn">Adicionar</button>
    </div>
  </form>
</div>

<!-- Modal para cadastro/edição de parente com validação e feedback -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content">
    <h2 id="modalTitle">Novo Parente</h2>
    <form id="formCadastroParente" novalidate>
      <!-- Nome do Parente (obrigatório) -->
      <div class="form-group">
        <label for="modalNome">Nome do Parente *</label>
        <input
          type="text"
          id="modalNome"
          class="cadastro-parente-input"
          required
          placeholder="Digite o nome"
        />
        <span
          class="cadastro-parente-feedback"
          id="feedbackNome"
          style="color: red"
        ></span>
      </div>
      <!-- Grau de Parentesco (obrigatório) -->
      <div class="form-group">
        <label for="modalGrau">Grau de Parentesco *</label>
        <input
          type="text"
          id="modalGrau"
          class="cadastro-parente-input"
          required
          placeholder="Ex: Pai, Mãe, Tio"
        />
        <span
          class="cadastro-parente-feedback"
          id="feedbackGrau"
          style="color: red"
        ></span>
      </div>
      <!-- Cidade (obrigatório) -->
      <div class="form-group">
        <label for="modalCidade">Cidade *</label>
        <input
          type="text"
          id="modalCidade"
          class="cadastro-parente-input"
          required
          placeholder="Digite a cidade"
        />
        <span
          class="cadastro-parente-feedback"
          id="feedbackCidade"
          style="color: red"
        ></span>
      </div>
      <!-- Outros campos opcionais -->
      <div class="form-group">
        <label for="modalData">Data de Nascimento</label>
        <input type="date" id="modalData" class="cadastro-parente-input" />
      </div>
      <div class="form-group">
        <label for="modalProfissao">Profissão</label>
        <input
          type="text"
          id="modalProfissao"
          class="cadastro-parente-input"
          placeholder="Digite a profissão"
        />
      </div>
      <div class="form-group">
        <label for="modalTelefone">Telefone</label>
        <input
          type="text"
          id="modalTelefone"
          class="cadastro-parente-input"
          placeholder="(xx) xxxx-xxxx"
          pattern="\(\d{2}\) \d{4,5}-\d{4}"
        />
        <span
          class="cadastro-parente-feedback"
          id="feedbackTelefone"
          style="color: red"
        ></span>
      </div>
      <div class="modal-switch-container">
        <label class="switch-label">
          Comprou Foto
          <label class="switch">
            <input type="checkbox" id="modalComprou" />
            <span class="slider"></span>
          </label>
        </label>
      </div>
      <!-- Botões -->
      <div class="modal-button-group">
        <button type="button" id="modalClose" class="btn btn-voltar">
          Cancelar
        </button>
        <button
          type="button"
          id="modalSave"
          class="btn cadastro-parente-btn-save"
          disabled
        >
          Salvar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- CONFIRMAÇÃO DE EXCLUSÃO -->
<div class="modal-overlay" id="confirmOverlay" style="display: none">
  <div class="modal-content">
    <h3 id="confirmTitle">Confirmação</h3>
    <p id="confirmMessage">Tem certeza?</p>
    <div class="modal-button-group">
      <button type="button" class="btn btn-voltar" id="confirmCancel">
        Cancelar
      </button>
      <button type="button" class="btn btn-danger" id="confirmOk">
        Excluir
      </button>
    </div>
  </div>
</div>

<!-- JavaScript para interatividade e validação -->
<script>
  // ——————————————————————————————————————————————
  // Globais
  // ——————————————————————————————————————————————
  let selectedStudentId = null;
  let editingParenteId = null;
  const nomeOriginalTurma = document
    .getElementById("nomeTurmaDisplay")
    .textContent.trim();

  // ——————————————————————————————————————————————
  // Atualiza resumo (Alunos, Parentes, Fotos)
  // ——————————————————————————————————————————————
  function updateSummary() {
    let totalParentes = 0,
      totalFotos = 0;
    document.querySelectorAll(".parente-count").forEach((el) => {
      totalParentes += parseInt(el.dataset.count) || 0;
      totalFotos += parseInt(el.dataset.fotos) || 0;
    });
    document.getElementById("total-parentes").textContent = totalParentes;
    document.getElementById("total-fotos").textContent = totalFotos;
    document.getElementById("total-alunos").textContent =
      document.querySelectorAll("tr.student-row").length;
  }

  // ——————————————————————————————————————————————
  // Renomear Turma
  // ——————————————————————————————————————————————
  function toggleEditArea() {
    const editDiv = document.getElementById("editarNomeTurma");
    if (editDiv.classList.contains("visible")) {
      editDiv.classList.remove("visible");
    } else {
      const input = document.getElementById("novaTurma");
      input.value = nomeOriginalTurma;
      editDiv.classList.add("visible");
      checkRenameFields();
      input.focus();
    }
  }
  document
    .getElementById("nomeTurmaDisplay")
    .addEventListener("click", toggleEditArea);
  document
    .getElementById("btnToggleEdit")
    .addEventListener("click", toggleEditArea);
  document.getElementById("btnCancelarEdicao").addEventListener("click", () => {
    document.getElementById("editarNomeTurma").classList.remove("visible");
  });
  const btnRenomear = document.querySelector(
    '#formRenomearTurma button[type="submit"]'
  );
  function checkRenameFields() {
    const v = document.getElementById("novaTurma").value.trim();
    btnRenomear.disabled = !(v.length >= 3 && v !== nomeOriginalTurma);
  }
  document
    .getElementById("novaTurma")
    .addEventListener("input", checkRenameFields);
  btnRenomear.disabled = true;

  // ——————————————————————————————————————————————
  // Ordenação A‑Z / Z‑A
  // ——————————————————————————————————————————————
  document.getElementById("orderToggle").addEventListener("click", function () {
    const next = this.dataset.order === "asc" ? "desc" : "asc";
    sortStudentRows(next);
    this.dataset.order = next;
    this.textContent = next === "asc" ? "Ordenar A-Z" : "Ordenar Z-A";
  });
  function sortStudentRows(order) {
    const tbody = document.getElementById("alunosBody"),
      arr = [];
    tbody.querySelectorAll("tr.student-row").forEach((row) => {
      const id = row.dataset.studentId;
      arr.push({
        row,
        parentRow: tbody.querySelector(
          `tr.parentes-row[data-student-id="${id}"]`
        ),
        name: row.dataset.studentName,
      });
    });
    arr.sort((a, b) =>
      order === "asc"
        ? a.name.localeCompare(b.name)
        : b.name.localeCompare(a.name)
    );
    tbody.innerHTML = "";
    arr.forEach((p) => {
      tbody.appendChild(p.row);
      tbody.appendChild(p.parentRow);
    });
  }

  // ——————————————————————————————————————————————
  // Fecha outras linhas expandidas
  // ——————————————————————————————————————————————
  function collapseOtherRows(currentId) {
    document.querySelectorAll("tr.student-row.expanded").forEach((row) => {
      if (row.dataset.studentId !== currentId) {
        const pr = document.querySelector(
          `tr.parentes-row[data-student-id="${row.dataset.studentId}"]`
        );
        pr.style.display = "none";
        row.classList.remove("expanded");
        const ic = row.querySelector(".toggle-icon");
        if (ic) ic.style.transform = "rotate(0deg)";
      }
    });
  }

  // ——————————————————————————————————————————————
  // Carrega Parentes via AJAX
  // ——————————————————————————————————————————————
  function carregarParentes(studentId) {
    fetch(`/turmas/listar_parents/${studentId}`)
      .then((r) => r.json())
      .then((data) => {
        const cont = document.getElementById(`parentes-container-${studentId}`);
        const cntEl = document.getElementById(`parente-count-${studentId}`);
        const fotos = data.filter((p) => p.comprou_foto).length;
        cntEl.dataset.count = data.length;
        cntEl.dataset.fotos = fotos;
        cntEl.textContent = `${data.length} parente(s) | Fotos Compradas: ${fotos}`;
        if (!data.length) {
          cont.innerHTML = "<p>Sem parentes cadastrados.</p>";
        } else {
          cont.innerHTML = data
            .map(
              (p) => `
            <div class="parent-item">
              <strong>${p.nome}</strong> – ${p.grau} – ${p.cidade}
              [${p.comprou_foto ? "Comprou" : "Não comprou"}]
              <button type="button" class="btn-editar btn-edit-parente"
                data-parente-id="${p.id}"
                data-student-id="${studentId}"
                data-parente-name="${p.nome}"
                data-parente-grau="${p.grau}"
                data-parente-cidade="${p.cidade}"
                data-parente-profissao="${p.profissao || ""}"
                data-parente-data-nascimento="${p.data_nascimento || ""}"
                data-parente-telefone="${p.telefone || ""}"
                data-parente-comprou="${p.comprou_foto}"
                title="Editar"></button>
              <button type="button" class="btn-excluir btn-delete-parente"
                data-parente-id="${p.id}"
                data-student-id="${studentId}"
                data-parente-name="${p.nome}"
                title="Excluir"></button>
            </div>
          `
            )
            .join("");
        }
        updateSummary();
      });
  }

  // ——————————————————————————————————————————————
  // Toggle de linha de aluno
  // ——————————————————————————————————————————————
  function toggleStudentRow(row) {
    const id = row.dataset.studentId;
    collapseOtherRows(id);
    const pr = document.querySelector(
      `tr.parentes-row[data-student-id="${id}"]`
    );
    const ic = row.querySelector(".toggle-icon");
    const open = !pr.style.display || pr.style.display === "none";
    if (open) {
      pr.style.display = "table-row";
      row.classList.add("expanded");
      if (ic) ic.style.transform = "rotate(180deg)";
      carregarParentes(id);
      row.scrollIntoView({ behavior: "smooth", block: "center" });
    } else {
      pr.style.display = "none";
      row.classList.remove("expanded");
      if (ic) ic.style.transform = "rotate(0deg)";
    }
  }

  // ——————————————————————————————————————————————
  // Abre Modal Parente
  // ——————————————————————————————————————————————
  function abrirModalParente(studentId) {
    selectedStudentId = studentId;
    editingParenteId = null;
    document.getElementById("modalTitle").textContent = "Novo Parente";
    document.getElementById("formCadastroParente").reset();
    document.getElementById("modalSave").disabled = true;
    document.getElementById("modalOverlay").style.display = "flex";
    checkFormFields();
  }
  document.getElementById("modalClose").addEventListener("click", () => {
    document.getElementById("modalOverlay").style.display = "none";
  });

  // ——————————————————————————————————————————————
  // Validação Modal Parente
  // ——————————————————————————————————————————————
  function validarFormularioParente() {
    let ok = true;
    [
      ["modalNome", "O nome é obrigatório."],
      ["modalGrau", "O grau é obrigatório."],
      ["modalCidade", "A cidade é obrigatória."],
    ].forEach(([id, msg]) => {
      const inp = document.getElementById(id),
        fb = document.getElementById("feedback" + id.replace("modal", ""));
      fb.textContent = "";
      if (!inp.value.trim()) {
        fb.textContent = msg;
        ok = false;
      }
    });
    return ok;
  }
  function checkFormFields() {
    document.getElementById("modalSave").disabled = !validarFormularioParente();
  }
  ["modalNome", "modalGrau", "modalCidade"].forEach((id) =>
    document.getElementById(id).addEventListener("input", checkFormFields)
  );

  // ——————————————————————————————————————————————
  // Salvar Modal Parente (criar ou editar)
  // ——————————————————————————————————————————————
  document.getElementById("modalSave").addEventListener("click", () => {
    if (!validarFormularioParente()) return checkFormFields();
    const body = {
      formando_id: selectedStudentId,
      nome: document.getElementById("modalNome").value,
      grau: document.getElementById("modalGrau").value,
      data_nascimento: document.getElementById("modalData").value,
      profissao: document.getElementById("modalProfissao").value,
      cidade: document.getElementById("modalCidade").value,
      telefone: document.getElementById("modalTelefone").value,
      comprou_foto: document.getElementById("modalComprou").checked,
    };
    const url = editingParenteId
      ? `/turmas/editar_parente/${editingParenteId}`
      : "/turmas/criar_parente";
    fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    })
      .then((r) => r.json())
      .then((data) => {
        if (data.success === false && data.message) {
          alert(data.message);
        } else {
          carregarParentes(selectedStudentId);
          document.getElementById("modalOverlay").style.display = "none";
        }
      });
  });

  // ——————————————————————————————————————————————
  // Modal Genérico de Confirmação
  // ——————————————————————————————————————————————
  let confirmCallback = null;
  function showConfirmModal(message, onConfirm) {
    document.getElementById("confirmMessage").textContent = message;
    confirmCallback = onConfirm;
    document.getElementById("confirmOverlay").style.display = "flex";
  }
  function hideConfirmModal() {
    document.getElementById("confirmOverlay").style.display = "none";
    confirmCallback = null;
  }
  document
    .getElementById("confirmCancel")
    .addEventListener("click", hideConfirmModal);
  document.getElementById("confirmOk").addEventListener("click", () => {
    if (confirmCallback) confirmCallback();
    hideConfirmModal();
  });

  // ——————————————————————————————————————————————
  // Delegation: Delete Aluno, Edit Parente, Delete Parente, Toggle Linha
  // ——————————————————————————————————————————————
  const tbodyEl = document.getElementById("alunosBody");
  tbodyEl.addEventListener("click", (e) => {
    // Excluir Aluno
    const btnAluno = e.target.closest(".btn-delete-aluno");
    if (btnAluno) {
      e.preventDefault();
      e.stopPropagation();
      const row = btnAluno.closest("tr.student-row");
      const alunoName = row.querySelector(".student-name").textContent;
      const href = btnAluno.getAttribute("href");
      showConfirmModal(`Excluir o aluno "${alunoName}"?`, () => {
        window.location.href = href;
      });
      return;
    }
    // Editar Parente
    const btnEditP = e.target.closest(".btn-edit-parente");
    if (btnEditP) {
      e.stopPropagation();
      editingParenteId = btnEditP.dataset.parenteId;
      selectedStudentId = btnEditP.dataset.studentId;
      document.getElementById("modalTitle").textContent = "Editar Parente";
      document.getElementById("modalNome").value = btnEditP.dataset.parenteName;
      document.getElementById("modalGrau").value = btnEditP.dataset.parenteGrau;
      document.getElementById("modalCidade").value =
        btnEditP.dataset.parenteCidade;
      document.getElementById("modalProfissao").value =
        btnEditP.dataset.parenteProfissao || "";
      document.getElementById("modalData").value =
        btnEditP.dataset.parenteDataNascimento || "";
      document.getElementById("modalTelefone").value =
        btnEditP.dataset.parenteTelefone || "";
      document.getElementById("modalComprou").checked =
        btnEditP.dataset.parenteComprou === "true";
      document.getElementById("modalSave").disabled = false;
      document.getElementById("modalOverlay").style.display = "flex";
      checkFormFields();
      return;
    }
    // Excluir Parente
    const btnPar = e.target.closest(".btn-delete-parente");
    if (btnPar) {
      e.stopPropagation();
      const parName = btnPar.dataset.parenteName;
      const studentId = btnPar.dataset.studentId;
      showConfirmModal(`Excluir o parente "${parName}"?`, () => {
        fetch(`/turmas/excluir_parente/${btnPar.dataset.parenteId}`, {
          method: "DELETE",
        })
          .then((r) => r.json())
          .then(() => carregarParentes(studentId));
      });
      return;
    }
    // Toggle linha de aluno
    const row = e.target.closest("tr.student-row");
    if (row && tbodyEl.contains(row)) {
      toggleStudentRow(row);
    }
  });

  // ——————————————————————————————————————————————
  // Novo Aluno (botão desabilitado até ≥3 chars e persistência)
  // ——————————————————————————————————————————————
  const formNovoAlunoEl = document.getElementById("novoAlunoForm");
  const inputAlunoEl = document.getElementById("aluno");
  const btnAddAluno = formNovoAlunoEl.querySelector('button[type="submit"]');
  btnAddAluno.disabled = true;
  inputAlunoEl.addEventListener("input", () => {
    btnAddAluno.disabled = inputAlunoEl.value.trim().length < 3;
  });
  document
    .getElementById("btnAbrirFormAluno")
    .addEventListener("click", function () {
      document.getElementById("formNovoAluno").classList.add("visible");
      this.style.display = "none";
      document
        .getElementById("formNovoAluno")
        .scrollIntoView({ behavior: "smooth" });
    });
  document.getElementById("btnCancelarAluno").addEventListener("click", () => {
    document.getElementById("formNovoAluno").classList.remove("visible");
    document.getElementById("btnAbrirFormAluno").style.display = "inline-block";
  });
  formNovoAlunoEl.addEventListener("submit", function (e) {
    e.preventDefault();
    if (inputAlunoEl.value.trim().length < 3) return;
    const fd = new FormData(this);
    fetch(this.action, { method: "POST", body: fd }).then((resp) => {
      if (resp.redirected) window.location.href = resp.url;
      else window.location.reload();
    });
  });

  // ——————————————————————————————————————————————
  // Inicialização
  // ——————————————————————————————————————————————
  window.addEventListener("load", () => {
    sortStudentRows(document.getElementById("orderToggle").dataset.order);
    updateSummary();
  });
</script>

{% endblock %}
