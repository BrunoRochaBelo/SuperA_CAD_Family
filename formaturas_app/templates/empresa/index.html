<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="color-scheme" content="light dark" />
    <title>Gerenciamento de Empresas</title>
    <link
      rel="icon"
      href="{{ url_for('static', filename='img/favicon.svg') }}"
      type="image/svg+xml"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <!-- CSS customizado -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <!-- Tippy.js CSS pra tooltips -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
  </head>
  <body>
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %}
    <div id="flash-messages">
      {% for category, msg in messages %}
      <div class="alert alert-{{ category|default('info') }}">
        <span class="alert-text">{{ msg }}</span>
        <button
          class="alert-close"
          onclick="this.parentElement.style.display='none';"
        >
          &times;
        </button>
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <!-- Expõe no JS o ID da empresa do super-admin -->
    <script>
      const CURRENT_EMPRESA_ID = {{ current_user.empresa_id }};
    </script>

    <div class="perfil-wrapper" style="margin-top: 20px"></div>
    <div class="container-floating">
      <div class="container">
        <h2>Gerenciamento de Empresas</h2>

        <!-- Resumo -->
        <div class="empresas-summary">
          Total de Empresas:
          <span id="total-empresas">{{ empresas|length }}</span>
        </div>

        <!-- Ordenação -->
        <div class="sorting">
          <button id="orderToggle" data-order="asc" class="btn">
            Ordenar A-Z
          </button>
        </div>

        <!-- Tabela -->
        <div class="table-responsive">
          <table class="table" id="empresasTable">
            <thead>
              <tr>
                <th>Empresa</th>
                <th>Situação</th>
                <th style="text-align: right">Ações</th>
              </tr>
            </thead>
            <tbody id="empresasBody">
              {% for emp in empresas %}
              <tr
                class="empresa-row"
                data-empresa-id="{{ emp.id }}"
                data-empresa-nome="{{ emp.nome|lower }}"
                data-empresa-status="{{ emp.status }}"
              >
                <td>
                  {{ emp.nome }}<br />
                  <small class="empresa-info">{{ emp.admin_email }}</small>
                </td>
                <td>{{ emp.status }}</td>
                <td
                  style="text-align: right"
                  onclick="event.stopPropagation();"
                >
                  <button
                    class="btn-editar"
                    data-empresa-id="{{ emp.id }}"
                    title="Editar"
                  ></button>
                  {% if emp.id != current_user.empresa_id %}
                  <button
                    class="btn-excluir"
                    data-empresa-id="{{ emp.id }}"
                    title="Excluir"
                  ></button>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Botões no rodapé -->
        <div class="profile-button-group">
          <div class="empresa-controls">
            <a
              href="{{ url_for('empresa.cadastrar_empresa') }}"
              class="btn btn-primary"
              >+ Adicionar empresa</a
            >
          </div>
          <a
            href="{{ url_for('auth.logout') }}"
            class="profile-btn btn-voltar btn-icon-text"
          >
            <span><!-- ícone logout --></span> Encerrar sessão
          </a>
        </div>

        <!-- Modal Editar (igual ao seu anterior) -->
        <div
          class="modal-overlay"
          id="modalEditarEmpresa"
          style="display: none"
        >
          <div class="modal-content">
            <h2>Editar Empresa</h2>
            <form id="formEditarEmpresa" novalidate>
              <input type="hidden" name="id" id="editEmpresaId" />
              <div class="form-group">
                <label for="editEmpresaNome">Nome da Empresa *</label>
                <input
                  type="text"
                  name="nome"
                  id="editEmpresaNome"
                  class="form-control"
                  required
                  placeholder="Digite o nome da empresa"
                />
                <span
                  class="feedback"
                  id="feedbackEditNome"
                  style="color: red"
                ></span>
              </div>
              <div class="form-group">
                <label for="editEmpresaStatus">Situação</label>
                <select
                  name="status"
                  id="editEmpresaStatus"
                  class="form-control"
                >
                  <option value="Ativa">Ativa</option>
                  <option value="Inativa">Inativa</option>
                </select>
              </div>
              <div class="modal-button-group">
                <button
                  type="button"
                  id="btnFecharModalEditarEmpresa"
                  class="btn btn-voltar"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  id="btnSalvarModalEditarEmpresa"
                  class="btn btn-primary"
                  disabled
                >
                  Salvar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Modal Excluir -->
        <div
          class="modal-overlay"
          id="modalExcluirEmpresa"
          style="display: none"
        >
          <div class="modal-content">
            <h2>Excluir Empresa</h2>
            <p>
              Tem certeza que deseja excluir a empresa
              <strong id="excluirEmpresaNome"></strong>?
            </p>
            <div class="modal-button-group">
              <button
                type="button"
                id="btnFecharModalExcluirEmpresa"
                class="btn btn-voltar"
              >
                Cancelar
              </button>
              <button
                type="button"
                id="btnConfirmarExclusaoEmpresa"
                class="btn btn-danger"
              >
                Excluir
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JS -->
    <script>
      window.onload = function () {
        // Auto-dismiss dos alerts: fade out e depois oculta o container
        setTimeout(function () {
          const flashDiv = document.getElementById("flash-messages");
          if (flashDiv) {
            flashDiv.style.opacity = "0";
            setTimeout(function () {
              flashDiv.style.display = "none";
            }, 500); // tempo para a transição
          }
        }, 5000);

        // Adiciona a classe "fade-in" para que o main fique visível
        document.querySelector("main").classList.add("fade-in");
      };
    </script>
    <script>
      // Atualiza a lista via API
      function updateEmpresaList() {
        fetch("{{ url_for('empresa.api_empresas') }}")
          .then((res) => res.json())
          .then((data) => {
            const empresas = data.empresas;
            document.getElementById("total-empresas").textContent =
              empresas.length;
            const tbody = document.getElementById("empresasBody");
            tbody.innerHTML = "";

            empresas.forEach((emp) => {
              const canDelete = emp.id !== CURRENT_EMPRESA_ID;
              const row = document.createElement("tr");
              row.className = "empresa-row";
              row.setAttribute("data-empresa-id", emp.id);
              row.setAttribute("data-empresa-nome", emp.nome.toLowerCase());
              row.setAttribute("data-empresa-status", emp.status);
              row.innerHTML = `
                <td>
                  ${emp.nome}<br>
                  <small class="empresa-info">${emp.admin_email}</small>
                </td>
                <td>${emp.status}</td>
                <td style="text-align: right">
                  <button class="btn-editar" data-empresa-id="${
                    emp.id
                  }" title="Editar"></button>
                  ${
                    canDelete
                      ? `<button class="btn-excluir" data-empresa-id="${emp.id}" title="Excluir"></button>`
                      : ""
                  }
                </td>
              `;
              tbody.appendChild(row);
            });

            attachEmpresaRowEvents();
          });
      }

      // Binda eventos de click nas linhas e botões
      function attachEmpresaRowEvents() {
        // Editar
        document.querySelectorAll(".empresa-row").forEach((row) => {
          row.addEventListener("click", (e) => {
            if (
              !e.target.closest(".btn-editar") &&
              !e.target.closest(".btn-excluir")
            ) {
              const id = row.dataset.empresaId;
              const nome = row.dataset.empresaNome;
              const status = row.dataset.empresaStatus;
              document.getElementById("editEmpresaId").value = id;
              document.getElementById("editEmpresaNome").value = nome;
              document.getElementById("editEmpresaStatus").value = status;
              originalNome = nome;
              originalStatus = status;
              document.getElementById("feedbackEditNome").textContent = "";
              document.getElementById(
                "btnSalvarModalEditarEmpresa"
              ).disabled = true;
              document.getElementById("modalEditarEmpresa").style.display =
                "flex";
            }
          });
        });

        // Excluir
        document.querySelectorAll(".btn-excluir").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const id = btn.dataset.empresaId;
            const nome = btn.closest("tr").dataset.empresaNome;
            document.getElementById("excluirEmpresaNome").textContent = nome;
            document
              .getElementById("modalExcluirEmpresa")
              .setAttribute("data-empresa-id", id);
            document.getElementById("modalExcluirEmpresa").style.display =
              "flex";
          });
        });
      }

      // Ordenação
      document
        .getElementById("orderToggle")
        .addEventListener("click", function () {
          const order =
            this.getAttribute("data-order") === "asc" ? "desc" : "asc";
          sortEmpresaRows(order);
          this.setAttribute("data-order", order);
          this.textContent = order === "asc" ? "Ordenar A-Z" : "Ordenar Z-A";
        });

      function sortEmpresaRows(order) {
        const tbody = document.getElementById("empresasBody");
        const rows = Array.from(tbody.querySelectorAll(".empresa-row"));
        rows.sort((a, b) => {
          const na = a.dataset.empresaNome;
          const nb = b.dataset.empresaNome;
          return order === "asc" ? na.localeCompare(nb) : nb.localeCompare(na);
        });
        rows.forEach((r) => tbody.appendChild(r));
      }

      // Fechar modais
      document
        .getElementById("btnFecharModalEditarEmpresa")
        .addEventListener("click", () => {
          document.getElementById("modalEditarEmpresa").style.display = "none";
        });
      document
        .getElementById("btnFecharModalExcluirEmpresa")
        .addEventListener("click", () => {
          document.getElementById("modalExcluirEmpresa").style.display = "none";
        });

      // Confirmar exclusão
      document
        .getElementById("btnConfirmarExclusaoEmpresa")
        .addEventListener("click", () => {
          const id = document
            .getElementById("modalExcluirEmpresa")
            .getAttribute("data-empresa-id");
          fetch(`/empresa/excluir_empresa/${id}`, { method: "DELETE" })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                flashMessage("Empresa excluída com sucesso!", "success");
                updateEmpresaList();
                document.getElementById("modalExcluirEmpresa").style.display =
                  "none";
              } else {
                alert("Erro: " + data.message);
              }
            });
        });

      // Função de flash na UI (reaproveita a sua)
      function flashMessage(message, category) {
        let flashContainer = document.getElementById("flash-messages");
        if (!flashContainer) {
          flashContainer = document.createElement("div");
          flashContainer.id = "flash-messages";
          document.body.appendChild(flashContainer);
        }
        flashContainer.style.display = "block";
        const flashDiv = document.createElement("div");
        flashDiv.className =
          "alert alert-" + (category === "success" ? "success" : category);
        flashDiv.innerHTML = `<span class="alert-text">${message}</span>
          <button class="alert-close" onclick="this.parentElement.remove();">×</button>`;
        flashContainer.appendChild(flashDiv);
        setTimeout(() => {
          flashDiv.style.opacity = "0";
          setTimeout(() => flashDiv.remove(), 500);
        }, 3000);
      }

      // On load
      window.addEventListener("load", () => {
        sortEmpresaRows(
          document.getElementById("orderToggle").getAttribute("data-order")
        );
        updateEmpresaList();
      });
    </script>
  </body>
</html>
