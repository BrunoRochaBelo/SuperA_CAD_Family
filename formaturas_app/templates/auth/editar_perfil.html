<div class="perfil-wrapper"></div>
{% extends 'base.html' %} {% block content %}
<!-- Cabeçalho -->
<h2>Editar Perfil</h2>

<!-- Formulário para editar dados do perfil -->
<form method="post" enctype="multipart/form-data" class="form-editar-perfil">
  <!-- Foto de Perfil e Tag de Acesso -->
  <div class="perfil-upload-container">
    <label for="foto_perfil" class="perfil-foto-label">
      {% if usuario.foto_perfil %}
      <img
        src="{{ url_for('static', filename=usuario.foto_perfil) }}"
        alt="Foto de Perfil"
        class="perfil-foto-preview"
      />
      {% else %}
      <div class="perfil-foto-placeholder">Selecionar Foto</div>
      {% endif %}
    </label>
    <span class="perfil-access-tag {{ usuario.papel.value|lower }}">
      {{ usuario.papel.value }}
    </span>

    <input
      type="file"
      name="foto_perfil"
      id="foto_perfil"
      class="perfil-file-input"
      accept="image/*"
    />
  </div>

  <!-- Campos de texto: Apenas Nome e Email (email somente leitura) -->
  <div class="form-group">
    <label for="nome">Nome:</label>
    <input
      type="text"
      name="nome"
      id="nome"
      class="form-editar-perfil-input"
      value="{{ usuario.nome }}"
      required
    />
  </div>

  <div class="form-group">
    <label for="email">Email (não editável)</label>
    <div
      class="input-readonly-wrapper"
      title="Este email é fixo e não pode ser alterado."
    >
      <input
        type="email"
        name="email"
        id="email"
        class="form-editar-perfil-input readonly-input"
        value="{{ usuario.email }}"
        required
        readonly
      />
      <span class="icone-cadeado" aria-hidden="true">&#128274;</span>
    </div>
  </div>

  <!-- Botões -->
  <div class="form-group form-btns">
    <button type="submit" class="btn editar-perfil-btn-save" disabled>
      Atualizar Perfil
    </button>
    <button id="openPasswordModal" type="button" class="btn">
      Alterar Senha
    </button>
  </div>
</form>

<!-- Modal para Alteração de Senha -->
<div id="passwordModal" class="modal-overlay">
  <div class="modal-content">
    <h2>Alterar Senha</h2>
    <form
      method="post"
      action="{{ url_for('perfil.alterar_senha') }}"
      id="passwordForm"
    >
      <div class="form-group">
        <label for="current_password">Senha Atual:</label>
        <input
          type="password"
          name="current_password"
          id="current_password"
          required
        />
      </div>
      <div class="form-group">
        <label for="new_password">Nova Senha:</label>
        <input type="password" name="new_password" id="new_password" required />
      </div>
      <div class="form-group">
        <label for="confirm_password">Confirmar Nova Senha:</label>
        <input
          type="password"
          name="confirm_password"
          id="confirm_password"
          required
        />
      </div>
      <!-- Feedback aprimorado para o formulário de senha -->
      <div
        id="passwordFeedback"
        style="color: red; font-size: 0.9rem; margin-top: 0.5rem"
      ></div>
      <div class="modal-button-group">
        <button type="button" id="passwordModalClose" class="btn btn-voltar">
          Cancelar
        </button>
        <button
          type="submit"
          id="modalAtualizarBtn"
          class="btn cadastro-parente-btn-save"
          disabled
        >
          Atualizar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    /* --- Lógica para o Formulário de Editar Perfil --- */
    const editarPerfilBtn = document.querySelector(".editar-perfil-btn-save");
    const nomeInput = document.getElementById("nome");
    const emailInput = document.getElementById("email");
    const fotoInput = document.getElementById("foto_perfil");

    // Guarda os valores iniciais para comparação
    const initialNome = nomeInput.value;
    const initialEmail = emailInput.value;
    let fotoChanged = false;

    editarPerfilBtn.disabled = true;

    function checkPerfilFormChanged() {
      // Como o campo email é readonly, a comparação fica apenas com o nome e a foto
      if (nomeInput.value !== initialNome || fotoChanged) {
        editarPerfilBtn.disabled = false;
      } else {
        editarPerfilBtn.disabled = true;
      }
    }

    nomeInput.addEventListener("input", checkPerfilFormChanged);
    fotoInput.addEventListener("change", function () {
      fotoChanged = true;
      checkPerfilFormChanged();
    });

    /* --- Lógica para o Modal de Alteração de Senha --- */
    const openPasswordModal = document.getElementById("openPasswordModal");
    const passwordModal = document.getElementById("passwordModal");
    const passwordModalClose = document.getElementById("passwordModalClose");
    const passwordForm = document.getElementById("passwordForm");
    const currentPasswordInput = document.getElementById("current_password");
    const newPasswordInput = document.getElementById("new_password");
    const confirmPasswordInput = document.getElementById("confirm_password");
    const modalAtualizarBtn = document.getElementById("modalAtualizarBtn");
    const passwordFeedback = document.getElementById("passwordFeedback");

    modalAtualizarBtn.disabled = true;

    function validatePasswordForm() {
      let valid = true;
      let errors = [];

      // Verifica se todos os campos estão preenchidos
      if (
        currentPasswordInput.value.trim() === "" ||
        newPasswordInput.value.trim() === "" ||
        confirmPasswordInput.value.trim() === ""
      ) {
        valid = false;
        errors.push("Preencha todos os campos.");
      }
      // Verifica se nova senha tem no mínimo 6 caracteres
      if (
        newPasswordInput.value.length > 0 &&
        newPasswordInput.value.length < 6
      ) {
        valid = false;
        errors.push("A nova senha deve ter no mínimo 6 caracteres.");
      }
      // Verifica se as novas senhas conferem
      if (newPasswordInput.value !== confirmPasswordInput.value) {
        valid = false;
        errors.push("As novas senhas não conferem.");
      }
      // Verifica se a nova senha é diferente da atual
      if (
        currentPasswordInput.value.trim() !== "" &&
        newPasswordInput.value === currentPasswordInput.value
      ) {
        valid = false;
        errors.push("A nova senha deve ser diferente da atual.");
      }

      passwordFeedback.textContent = errors.join(" ");
      modalAtualizarBtn.disabled = !valid;
    }

    [newPasswordInput, confirmPasswordInput].forEach((input) => {
      input.addEventListener("input", validatePasswordForm);
    });

    currentPasswordInput.addEventListener("blur", function () {
      const currentPass = currentPasswordInput.value.trim();
      if (currentPass === "") return;
      fetch('{{ url_for("perfil.validar_senha") }}', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ current_password: currentPass }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (!data.valid) {
            passwordFeedback.textContent = "Senha atual incorreta.";
            modalAtualizarBtn.disabled = true;
          } else {
            passwordFeedback.textContent = "";
            validatePasswordForm();
          }
        })
        .catch((error) => {
          console.error("Erro na validação da senha atual:", error);
        });
    });

    // Abre o modal de alteração de senha
    openPasswordModal.addEventListener("click", () => {
      passwordModal.style.display = "flex";
      passwordModal.classList.add("show");
    });

    // Fecha o modal ao clicar em "Cancelar" ou fora do conteúdo
    passwordModalClose.addEventListener("click", () => {
      passwordModal.classList.remove("show");
      setTimeout(() => {
        passwordModal.style.display = "none";
        passwordForm.reset();
        passwordFeedback.textContent = "";
        modalAtualizarBtn.disabled = true;
      }, 300);
    });
    window.addEventListener("click", function (event) {
      if (event.target === passwordModal) {
        passwordModal.classList.remove("show");
        setTimeout(() => {
          passwordModal.style.display = "none";
          passwordForm.reset();
          passwordFeedback.textContent = "";
          modalAtualizarBtn.disabled = true;
        }, 300);
      }
    });
  });
</script>
{% endblock %}
