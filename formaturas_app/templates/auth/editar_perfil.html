<div class="perfil-wrapper"></div>
{% extends 'base.html' %} {% block content %}
<!-- Cabeçalho -->
<h2>Editar Perfil</h2>

<!-- Formulário para editar dados do perfil -->
<form method="post" enctype="multipart/form-data" class="form-editar-perfil">
  <!-- Foto de Perfil e Tag de Acesso -->
  <div class="perfil-upload-container">
    <div id="foto-perfil-container" class="foto-perfil-container">
      {% if usuario.foto_perfil %}
      <img
        src="{{ url_for('static', filename=usuario.foto_perfil) }}"
        alt="Foto de Perfil"
        class="perfil-foto-preview"
        id="current-profile-photo"
      />
      {% else %}
      <div class="perfil-foto-placeholder" id="profile-placeholder">
        <i class="fas fa-user"></i>
        <span>Adicionar Foto</span>
      </div>
      {% endif %}
    </div>
    <span class="perfil-access-tag {{ usuario.papel.value|lower }}">
      {{ usuario.papel.value }}
    </span>
  </div>

  <!-- Modal para Gerenciamento de Foto -->
  <div id="photoModal" class="modal-overlay">
    <div class="modal-content photo-editor-modal">
      <h2 id="photo-modal-title">
        {% if usuario.foto_perfil %}Ajustar Foto{% else %}Adicionar Foto{% endif
        %}
      </h2>
      <div class="photo-editor-container">
        <div class="photo-editor-wrapper">
          <div id="photo-editor-area">
            {% if usuario.foto_perfil %}
            <img
              id="photo-editor-image"
              src="{{ url_for('static', filename=usuario.foto_perfil) }}"
              alt="Foto de Perfil"
            />
            {% else %}
            <div id="photo-editor-placeholder">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Selecione uma imagem para carregar</p>
            </div>
            {% endif %}
          </div>
        </div>
        <div class="photo-editor-instructions">
          <p>Você pode arrastar a imagem e usar a roda do mouse para zoom.</p>
          <p>
            Ajuste a foto para se enquadrar melhor no círculo de visualização.
          </p>
        </div>
      </div>
      <div class="photo-editor-controls">
        <div class="zoom-controls">
          <button
            type="button"
            id="zoom-out-btn"
            class="zoom-btn"
            title="Diminuir zoom"
          ></button>
          <input
            type="range"
            id="zoom-slider"
            min="100"
            max="300"
            value="100"
          />
          <button
            type="button"
            id="zoom-in-btn"
            class="zoom-btn"
            title="Aumentar zoom"
          ></button>
        </div>
      </div>
      <div class="photo-editor-actions">
        <input
          type="file"
          id="photo-upload"
          accept="image/*"
          style="display: none"
        />
        {% if usuario.foto_perfil %}
        <button type="button" id="delete-photo-btn" class="btn btn-voltar">
          <i class="fas fa-trash"></i> Excluir Foto
        </button>
        {% else %}
        <button type="button" id="select-photo-btn" class="btn btn-secondary">
          <i class="fas fa-upload"></i> Selecionar Imagem
        </button>
        {% endif %}
        <button type="button" id="photo-modal-cancel" class="btn btn-voltar">
          Cancelar
        </button>
        <button
          type="button"
          id="save-photo-btn"
          class="btn btn-primary"
          disabled
        >
          Salvar
        </button>
      </div>
    </div>
  </div>

  <!-- Campo oculto para armazenar os dados da imagem processada -->
  <input type="hidden" name="cropped_image_data" id="cropped_image_data" />

  <!-- Campos de texto: Nome e Email (não editável) -->
  <div class="form-group">
    <label for="nome">Nome:</label>
    <input
      type="text"
      name="nome"
      id="nome"
      class="form-editar-perfil-input"
      value="{{ usuario.nome }}"
      required
    />
  </div>

  <div class="form-group">
    <label for="email">Email (não editável)</label>
    <div
      class="input-readonly-wrapper"
      title="Este email é fixo e não pode ser alterado."
    >
      <input
        type="email"
        name="email"
        id="email"
        class="form-editar-perfil-input readonly-input"
        value="{{ usuario.email }}"
        required
        readonly
      />
      <span class="icone-cadeado" aria-hidden="true">&#128274;</span>
    </div>
  </div>

  <!-- Botões -->
  <div class="form-group form-btns">
    <button type="submit" class="btn editar-perfil-btn-save" disabled>
      Atualizar Perfil
    </button>
    <button id="openPasswordModal" type="button" class="btn">
      Alterar Senha
    </button>
  </div>
</form>
<div class="mai-footer">
  <a
    href="{{ url_for('auth.logout') }}"
    class="profile-btn btn-voltar btn-icon-text"
  >
    <span>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
    </span>
    Encerrar sessão
  </a>
</div>
<!-- Modal para Confirmação de Exclusão da Imagem -->
<div id="confirmDeleteModal" class="modal-overlay">
  <div class="modal-content">
    <h2>Confirmar Exclusão</h2>
    <p>Tem certeza que deseja excluir sua foto de perfil?</p>
    <div class="modal-button-group">
      <button type="button" id="cancelDeleteBtn" class="btn btn-secondary">
        Cancelar
      </button>
      <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
        Sim, excluir
      </button>
    </div>
  </div>
</div>

<!-- Modal para Alteração de Senha -->
{% include 'partials/modal_alterar_senha.html' with context %}
<script src="{{ url_for('static', filename='js/alterar_senha_modal.js') }}"></script>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>

<!-- Scripts -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const editarPerfilBtn = document.querySelector(".editar-perfil-btn-save");
    const nomeInput = document.getElementById("nome");
    const initialNome = nomeInput.value;
    let fotoChanged = false;

    // Zoom elements
    const zoomSlider = document.getElementById("zoom-slider");
    const zoomInBtn = document.getElementById("zoom-in-btn");
    const zoomOutBtn = document.getElementById("zoom-out-btn");
    const zoomPercent = document.createElement("span");
    zoomPercent.id = "zoom-percentage";
    zoomPercent.innerText = "100%";
    document.querySelector(".zoom-controls").appendChild(zoomPercent);

    // Habilita o botão “Atualizar Perfil”
    editarPerfilBtn.disabled = true;
    function checkPerfilFormChanged() {
      editarPerfilBtn.disabled = !(
        nomeInput.value !== initialNome || fotoChanged
      );
    }
    nomeInput.addEventListener("input", checkPerfilFormChanged);

    // Componentes do modal
    const photoModal = document.getElementById("photoModal");
    const photoContainer = document.getElementById("foto-perfil-container");
    const photoUploadInput = document.getElementById("photo-upload");
    const photoEditorArea = document.getElementById("photo-editor-area");
    const savePhotoBtn = document.getElementById("save-photo-btn");
    const cancelBtn = document.getElementById("photo-modal-cancel");
    let cropper = null;
    let originalModalState = {};

    function setZoomControls(on) {
      [zoomSlider, zoomInBtn, zoomOutBtn].forEach((el) => (el.disabled = !on));
      zoomPercent.style.visibility = on ? "visible" : "hidden";
    }

    function saveOriginalState() {
      originalModalState = {
        html: photoEditorArea.innerHTML,
        btnClone: (
          document.getElementById("select-photo-btn") ||
          document.getElementById("delete-photo-btn")
        ).cloneNode(true),
        saveDisabled: savePhotoBtn.disabled,
        zoomValue: +zoomSlider.value,
      };
    }
    function restoreOriginalState() {
      photoEditorArea.innerHTML = originalModalState.html;
      const currBtn =
        document.getElementById("select-photo-btn") ||
        document.getElementById("delete-photo-btn");
      if (currBtn)
        currBtn.replaceWith(originalModalState.btnClone.cloneNode(true));
      savePhotoBtn.disabled = originalModalState.saveDisabled;
      zoomSlider.value = originalModalState.zoomValue;
      zoomPercent.innerText = originalModalState.zoomValue + "%";
      setZoomControls(!!document.getElementById("photo-editor-image"));
      bindActionBtn();
      if (document.getElementById("photo-editor-image")) initCropper();
    }

    function bindActionBtn() {
      const btn =
        document.getElementById("select-photo-btn") ||
        document.getElementById("delete-photo-btn");
      if (!btn) return;
      btn.replaceWith(btn.cloneNode(true));
      const fresh =
        document.getElementById("select-photo-btn") ||
        document.getElementById("delete-photo-btn");
      if (fresh.id === "select-photo-btn") {
        fresh.addEventListener("click", () => photoUploadInput.click());
      } else {
        fresh.addEventListener("click", handleDeleteImage);
      }
    }

    function handleDeleteImage() {
      if (cropper) cropper.destroy(), (cropper = null);
      photoEditorArea.innerHTML = `
        <div id="photo-editor-placeholder">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Arraste ou selecione uma imagem</p>
        </div>`;
      savePhotoBtn.disabled = false;
      fotoChanged = true;
      checkPerfilFormChanged();
      swapToSelectBtn();
    }

    function swapToSelectBtn() {
      const btn = document.getElementById("delete-photo-btn");
      btn.id = "select-photo-btn";
      btn.innerHTML = '<i class="fas fa-upload"></i> Selecionar Imagem';
      btn.classList.replace("btn-voltar", "btn-secondary");
      bindActionBtn();
    }
    function swapToDeleteBtn() {
      const btn = document.getElementById("select-photo-btn");
      btn.id = "delete-photo-btn";
      btn.innerHTML = '<i class="fas fa-trash"></i> Excluir Imagem';
      btn.classList.replace("btn-secondary", "btn-voltar");
      bindActionBtn();
    }

    function openPhotoModal() {
      saveOriginalState();
      photoModal.style.display = "flex";
      setTimeout(() => photoModal.classList.add("show"), 10);
      setZoomControls(!!document.getElementById("photo-editor-image"));
      if (document.getElementById("photo-editor-image")) initCropper();
    }
    function closePhotoModal() {
      photoModal.classList.remove("show");
      setTimeout(() => (photoModal.style.display = "none"), 300);
    }

    // ** Aqui a mágica do Cropper com slider sincronizado **
    function initCropper() {
      const img = document.getElementById("photo-editor-image");
      if (!img) return;
      cropper?.destroy();

      let minRatio = 1;
      cropper = new Cropper(img, {
        aspectRatio: 1,
        viewMode: 1,
        dragMode: "move",
        guides: false,
        background: false,
        autoCropArea: 1,
        cropBoxMovable: false,
        cropBoxResizable: false,
        movable: true,
        zoomable: true,
        scalable: false,
        rotatable: false,
        ready() {
          // calcula o cover mínimo e aplica
          const cData = cropper.getContainerData();
          const iData = cropper.getImageData();
          minRatio = Math.max(
            cData.width / iData.naturalWidth,
            cData.height / iData.naturalHeight
          );
          cropper.minRatio = minRatio;
          cropper.zoomTo(minRatio);
          cropper.setCropBoxData({
            left: cData.left,
            top: cData.top,
            width: cData.width,
            height: cData.height,
          });

          // slider relativo a esse minRatio
          zoomSlider.min = 100;
          zoomSlider.max = 300;
          zoomSlider.step = 1;
          zoomSlider.value = 100;
          zoomPercent.innerText = "100%";

          savePhotoBtn.disabled = false;
          setZoomControls(true);
        },
        zoom(event) {
          // sempre que zoomar por scroll/pinça, atualiza slider
          const d = event.detail;
          // detail.oldRatio e detail.ratio são fatores relativos
          // mas vamos pegar o valor absoluto:
          const imgData = cropper.getImageData();
          const currentRatio = imgData.width / imgData.naturalWidth;
          const percent = (currentRatio / cropper.minRatio) * 100;
          zoomSlider.value = percent;
          zoomPercent.innerText = Math.round(percent) + "%";
        },
      });
    }

    // upload via input ou drag&drop
    function handleImageUpload(e) {
      const file = e.dataTransfer ? e.dataTransfer.files[0] : e.target.files[0];
      if (!file || !file.type.match("image.*"))
        return alert("Imagem inválida!");
      const reader = new FileReader();
      reader.onload = (ev) => {
        photoEditorArea.innerHTML = "";
        const img = document.createElement("img");
        img.id = "photo-editor-image";
        img.src = ev.target.result;
        photoEditorArea.appendChild(img);
        img.onload = () => {
          initCropper();
          fotoChanged = true;
          checkPerfilFormChanged();
          swapToDeleteBtn();
        };
      };
      reader.readAsDataURL(file);
    }

    // listeners de zoom
    zoomSlider.addEventListener("input", () => {
      const pct = +zoomSlider.value;
      zoomPercent.innerText = pct + "%";
      if (cropper) {
        const newRatio = (pct / 100) * cropper.minRatio;
        cropper.zoomTo(newRatio);
      }
    });
    zoomInBtn.addEventListener("click", () => {
      zoomSlider.value = Math.min(300, +zoomSlider.value + 10);
      zoomSlider.dispatchEvent(new Event("input"));
    });
    zoomOutBtn.addEventListener("click", () => {
      zoomSlider.value = Math.max(100, +zoomSlider.value - 10);
      zoomSlider.dispatchEvent(new Event("input"));
    });

    // salvar (crop ou delete)
    function savePhoto() {
      if (!cropper && !document.getElementById("photo-editor-image")) {
        let del = document.querySelector('input[name="delete_photo"]');
        if (!del) {
          del = document.createElement("input");
          del.type = "hidden";
          del.name = "delete_photo";
          del.value = "true";
          document.querySelector(".form-editar-perfil").appendChild(del);
        }
        document.getElementById("cropped_image_data").value = "";
        document.querySelector(".form-editar-perfil").submit();
        closePhotoModal();
        return;
      }
      const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
      document.getElementById("cropped_image_data").value =
        canvas.toDataURL("image/jpeg");
      document.querySelector(".form-editar-perfil").submit();
      closePhotoModal();
    }

    // eventos gerais
    photoContainer.addEventListener("click", openPhotoModal);
    photoUploadInput.addEventListener("change", handleImageUpload);
    savePhotoBtn.addEventListener("click", savePhoto);
    cancelBtn.addEventListener("click", () => {
      restoreOriginalState();
      closePhotoModal();
    });

    bindActionBtn();
  });
</script>

{% endblock %}
