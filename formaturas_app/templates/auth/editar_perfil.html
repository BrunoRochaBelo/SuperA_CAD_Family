<div class="perfil-wrapper"></div>
{% extends 'base.html' %} {% block content %}
<!-- Cabeçalho -->
<h2>Editar Perfil</h2>

<!-- Formulário para editar dados do perfil -->
<form method="post" enctype="multipart/form-data" class="form-editar-perfil">
  <!-- Foto de Perfil e Tag de Acesso -->
  <div class="perfil-upload-container">
    <div id="foto-perfil-container" class="foto-perfil-container">
      {% if usuario.foto_perfil %}
      <img
        src="{{ url_for('static', filename=usuario.foto_perfil) }}"
        alt="Foto de Perfil"
        class="perfil-foto-preview"
        id="current-profile-photo"
      />
      {% else %}
      <div class="perfil-foto-placeholder" id="profile-placeholder">
        <i class="fas fa-user"></i>
        <span>Adicionar Foto</span>
      </div>
      {% endif %}
    </div>
    <span class="perfil-access-tag {{ usuario.papel.value|lower }}">
      {{ usuario.papel.value }}
    </span>
  </div>

  <!-- Modal para Gerenciamento de Foto -->
  <div id="photoModal" class="modal-overlay">
    <div class="modal-content photo-editor-modal">
      <h2 id="photo-modal-title">
        {% if usuario.foto_perfil %}Ajustar Foto{% else %}Adicionar Foto{% endif
        %}
      </h2>
      <div class="photo-editor-container">
        <div class="photo-editor-wrapper">
          <div id="photo-editor-area">
            {% if usuario.foto_perfil %}
            <img
              id="photo-editor-image"
              src="{{ url_for('static', filename=usuario.foto_perfil) }}"
              alt="Foto de Perfil"
            />
            {% else %}
            <div id="photo-editor-placeholder">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Selecione uma imagem para carregar</p>
            </div>
            {% endif %}
          </div>
        </div>
        <div class="photo-editor-instructions">
          <p>Você pode arrastar a imagem e usar a roda do mouse para zoom.</p>
          <p>
            Ajuste a foto para se enquadrar melhor no círculo de visualização.
          </p>
        </div>
      </div>
      <div class="photo-editor-controls">
        <div class="zoom-controls">
          <button
            type="button"
            id="zoom-out-btn"
            class="zoom-btn"
            title="Diminuir zoom"
          ></button>
          <input
            type="range"
            id="zoom-slider"
            min="100"
            max="300"
            value="100"
          />
          <button
            type="button"
            id="zoom-in-btn"
            class="zoom-btn"
            title="Aumentar zoom"
          ></button>
        </div>
      </div>
      <div class="photo-editor-actions">
        <input
          type="file"
          id="photo-upload"
          accept="image/*"
          style="display: none"
        />
        {% if usuario.foto_perfil %}
        <button type="button" id="delete-photo-btn" class="btn btn-voltar">
          <i class="fas fa-trash"></i> Excluir Foto
        </button>
        {% else %}
        <button type="button" id="select-photo-btn" class="btn btn-secondary">
          <i class="fas fa-upload"></i> Selecionar Imagem
        </button>
        {% endif %}
        <button type="button" id="photo-modal-cancel" class="btn btn-voltar">
          Cancelar
        </button>
        <button
          type="button"
          id="save-photo-btn"
          class="btn btn-primary"
          disabled
        >
          Salvar
        </button>
      </div>
    </div>
  </div>

  <!-- Campo oculto para armazenar os dados da imagem processada -->
  <input type="hidden" name="cropped_image_data" id="cropped_image_data" />

  <!-- Campos de texto: Nome e Email (não editável) -->
  <div class="form-group">
    <label for="nome">Nome:</label>
    <input
      type="text"
      name="nome"
      id="nome"
      class="form-editar-perfil-input"
      value="{{ usuario.nome }}"
      required
    />
  </div>

  <div class="form-group">
    <label for="email">Email (não editável)</label>
    <div
      class="input-readonly-wrapper"
      title="Este email é fixo e não pode ser alterado."
    >
      <input
        type="email"
        name="email"
        id="email"
        class="form-editar-perfil-input readonly-input"
        value="{{ usuario.email }}"
        required
        readonly
      />
      <span class="icone-cadeado" aria-hidden="true">&#128274;</span>
    </div>
  </div>

  <!-- Botões -->
  <div class="form-group form-btns">
    <button type="submit" class="btn editar-perfil-btn-save" disabled>
      Atualizar Perfil
    </button>
    <button id="openPasswordModal" type="button" class="btn">
      Alterar Senha
    </button>
  </div>
</form>
<div class="mai-footer">
  <a
    href="{{ url_for('auth.logout') }}"
    class="profile-btn btn-voltar btn-icon-text"
  >
    <span>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
    </span>
    Encerrar sessão
  </a>
</div>
<!-- Modal para Confirmação de Exclusão da Imagem -->
<div id="confirmDeleteModal" class="modal-overlay">
  <div class="modal-content">
    <h2>Confirmar Exclusão</h2>
    <p>Tem certeza que deseja excluir sua foto de perfil?</p>
    <div class="modal-button-group">
      <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
        Sim, excluir
      </button>
      <button type="button" id="cancelDeleteBtn" class="btn btn-secondary">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal para Alteração de Senha -->
<div id="passwordModal" class="modal-overlay">
  <div class="modal-content">
    <h2>Alterar Senha</h2>
    <form
      method="post"
      action="{{ url_for('perfil.alterar_senha') }}"
      id="passwordForm"
    >
      <div class="form-group">
        <label for="current_password">Senha Atual:</label>
        <div class="password-wrapper" style="position: relative">
          <input
            type="password"
            name="current_password"
            id="current_password"
            required
          />
          <span
            class="toggle-password"
            onclick="togglePasswordVisibility('current_password', this)"
            style="
              position: absolute;
              right: 10px;
              top: 50%;
              transform: translateY(-50%);
              cursor: pointer;
            "
          >
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g class="eye-visible">
                <path
                  d="M12 5C7 5 2.73 8.11 1 12C2.73 15.89 7 19 12 19C17 19 21.27 15.89 23 12C21.27 8.11 17 5 12 5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                />
              </g>
              <g class="eye-hidden" style="display: none">
                <path
                  d="M12 5C7 5 2.73 8.11 1 12C2.73 15.89 7 19 12 19C17 19 21.27 15.89 23 12C21.27 8.11 17 5 12 5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                />
                <path
                  d="M2 4L22 20"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </g>
            </svg>
          </span>
        </div>
        <div class="input-feedback" id="currentPasswordFeedback"></div>
      </div>

      <div class="form-group">
        <label for="new_password">Nova Senha:</label>
        <div class="password-wrapper" style="position: relative">
          <input
            type="password"
            name="new_password"
            id="new_password"
            required
          />
          <span
            class="toggle-password"
            onclick="togglePasswordVisibility('new_password', this)"
            style="
              position: absolute;
              right: 10px;
              top: 50%;
              transform: translateY(-50%);
              cursor: pointer;
            "
          >
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g class="eye-visible">
                <path
                  d="M12 5C7 5 2.73 8.11 1 12C2.73 15.89 7 19 12 19C17 19 21.27 15.89 23 12C21.27 8.11 17 5 12 5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                />
              </g>
              <g class="eye-hidden" style="display: none">
                <path
                  d="M12 5C7 5 2.73 8.11 1 12C2.73 15.89 7 19 12 19C17 19 21.27 15.89 23 12C21.27 8.11 17 5 12 5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                />
                <path
                  d="M2 4L22 20"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </g>
            </svg>
          </span>
        </div>
        <div class="input-feedback" id="newPasswordFeedback"></div>
      </div>

      <div class="form-group">
        <label for="confirm_password">Confirmar Nova Senha:</label>
        <div class="password-wrapper" style="position: relative">
          <input
            type="password"
            name="confirm_password"
            id="confirm_password"
            required
          />
          <span
            class="toggle-password"
            onclick="togglePasswordVisibility('confirm_password', this)"
            style="
              position: absolute;
              right: 10px;
              top: 50%;
              transform: translateY(-50%);
              cursor: pointer;
            "
          >
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g class="eye-visible">
                <path
                  d="M12 5C7 5 2.73 8.11 1 12C2.73 15.89 7 19 12 19C17 19 21.27 15.89 23 12C21.27 8.11 17 5 12 5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                />
              </g>
              <g class="eye-hidden" style="display: none">
                <path
                  d="M12 5C7 5 2.73 8.11 1 12C2.73 15.89 7 19 12 19C17 19 21.27 15.89 23 12C21.27 8.11 17 5 12 5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                />
                <path
                  d="M2 4L22 20"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </g>
            </svg>
          </span>
        </div>
        <div class="input-feedback" id="confirmPasswordFeedback"></div>
      </div>

      <div class="password-requirements">
        <p>A senha deve conter:</p>
        <ul>
          <li id="req-length">Mínimo de 6 caracteres</li>
          <li id="req-letter">Pelo menos uma letra</li>
          <li id="req-number">Pelo menos um número</li>
        </ul>
      </div>
      <div class="modal-button-group">
        <button type="button" id="passwordModalClose" class="btn btn-voltar">
          Cancelar
        </button>
        <button
          type="submit"
          id="modalAtualizarBtn"
          class="btn cadastro-parente-btn-save"
          disabled
        >
          Atualizar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ----- Função para alternar a visibilidade da senha -----
    function togglePasswordVisibility(inputId, toggler) {
      const input = document.getElementById(inputId);
      if (input.getAttribute("type") === "password") {
        input.setAttribute("type", "text");
        toggler.querySelector(".eye-visible").style.display = "none";
        toggler.querySelector(".eye-hidden").style.display = "block";
      } else {
        input.setAttribute("type", "password");
        toggler.querySelector(".eye-visible").style.display = "block";
        toggler.querySelector(".eye-hidden").style.display = "none";
      }
    }

    // ----- Lógica do formulário de editar perfil -----
    const editarPerfilBtn = document.querySelector(".editar-perfil-btn-save");
    const nomeInput = document.getElementById("nome");
    const emailInput = document.getElementById("email");
    const initialNome = nomeInput.value;
    let fotoChanged = false;
    editarPerfilBtn.disabled = true;

    function checkPerfilFormChanged() {
      if (nomeInput.value !== initialNome || fotoChanged) {
        editarPerfilBtn.disabled = false;
      } else {
        editarPerfilBtn.disabled = true;
      }
    }
    nomeInput.addEventListener("input", checkPerfilFormChanged);

    // ----- Modal de Alteração de Senha -----
    const openPasswordModal = document.getElementById("openPasswordModal");
    const passwordModal = document.getElementById("passwordModal");
    const passwordModalClose = document.getElementById("passwordModalClose");
    const passwordForm = document.getElementById("passwordForm");
    const currentPasswordInput = document.getElementById("current_password");
    const newPasswordInput = document.getElementById("new_password");
    const confirmPasswordInput = document.getElementById("confirm_password");
    const modalAtualizarBtn = document.getElementById("modalAtualizarBtn");

    const currentPasswordFeedback = document.getElementById(
      "currentPasswordFeedback"
    );
    const newPasswordFeedback = document.getElementById("newPasswordFeedback");
    const confirmPasswordFeedback = document.getElementById(
      "confirmPasswordFeedback"
    );

    const reqLength = document.getElementById("req-length");
    const reqLetter = document.getElementById("req-letter");
    const reqNumber = document.getElementById("req-number");

    let currentPasswordValid = false;
    let newPasswordValid = false;
    let confirmPasswordValid = false;
    modalAtualizarBtn.disabled = true;

    function clearAllFeedbacks() {
      currentPasswordFeedback.textContent = "";
      currentPasswordFeedback.className = "input-feedback";
      newPasswordFeedback.textContent = "";
      newPasswordFeedback.className = "input-feedback";
      confirmPasswordFeedback.textContent = "";
      confirmPasswordFeedback.className = "input-feedback";
      reqLength.className = "";
      reqLetter.className = "";
      reqNumber.className = "";
      currentPasswordValid = false;
      newPasswordValid = false;
      confirmPasswordValid = false;
    }

    function checkPasswordRequirements(password) {
      const requirements = {
        length: password.length >= 6,
        letter: /[a-zA-Z]/.test(password),
        number: /[0-9]/.test(password),
      };
      reqLength.className = requirements.length ? "requirement-met" : "";
      reqLetter.className = requirements.letter ? "requirement-met" : "";
      reqNumber.className = requirements.number ? "requirement-met" : "";
      return requirements.length && requirements.letter && requirements.number;
    }

    function updateButtonState() {
      modalAtualizarBtn.disabled = !(
        currentPasswordValid &&
        newPasswordValid &&
        confirmPasswordValid
      );
    }

    currentPasswordInput.addEventListener("input", function () {
      const currentPass = currentPasswordInput.value.trim();
      if (currentPass === "") {
        currentPasswordFeedback.textContent = "Preencha a senha atual.";
        currentPasswordFeedback.className = "input-feedback error-feedback";
        currentPasswordValid = false;
      } else if (currentPasswordValid) {
        currentPasswordFeedback.textContent = "✓";
        currentPasswordFeedback.className = "input-feedback success-feedback";
      } else {
        currentPasswordFeedback.textContent = "";
        currentPasswordFeedback.className = "input-feedback";
      }
      updateButtonState();
    });

    newPasswordInput.addEventListener("input", function () {
      const newPass = newPasswordInput.value.trim();
      const currentPass = currentPasswordInput.value.trim();
      const requirementsMet = checkPasswordRequirements(newPass);

      if (newPass === "") {
        newPasswordFeedback.textContent = "Informe uma nova senha.";
        newPasswordFeedback.className = "input-feedback error-feedback";
        newPasswordValid = false;
      } else if (!requirementsMet) {
        newPasswordFeedback.textContent = "A senha não atende aos requisitos.";
        newPasswordFeedback.className = "input-feedback error-feedback";
        newPasswordValid = false;
      } else if (newPass === currentPass && currentPass !== "") {
        newPasswordFeedback.textContent =
          "A nova senha deve ser diferente da atual.";
        newPasswordFeedback.className = "input-feedback error-feedback";
        newPasswordValid = false;
      } else {
        newPasswordFeedback.textContent = "✓";
        newPasswordFeedback.className = "input-feedback success-feedback";
        newPasswordValid = true;
      }

      const confirmPass = confirmPasswordInput.value.trim();
      if (confirmPass !== "") {
        if (confirmPass === newPass && requirementsMet) {
          confirmPasswordFeedback.textContent = "✓";
          confirmPasswordFeedback.className = "input-feedback success-feedback";
          confirmPasswordValid = true;
        } else {
          confirmPasswordFeedback.textContent = "As senhas não conferem.";
          confirmPasswordFeedback.className = "input-feedback error-feedback";
          confirmPasswordValid = false;
        }
      }
      updateButtonState();
    });

    confirmPasswordInput.addEventListener("input", function () {
      const confirmPass = confirmPasswordInput.value.trim();
      const newPass = newPasswordInput.value.trim();
      const requirementsMet = checkPasswordRequirements(newPass);
      if (confirmPass === "") {
        confirmPasswordFeedback.textContent = "Confirme a nova senha.";
        confirmPasswordFeedback.className = "input-feedback error-feedback";
        confirmPasswordValid = false;
      } else if (confirmPass !== newPass) {
        confirmPasswordFeedback.textContent = "As senhas não conferem.";
        confirmPasswordFeedback.className = "input-feedback error-feedback";
        confirmPasswordValid = false;
      } else if (confirmPass === newPass && requirementsMet) {
        confirmPasswordFeedback.textContent = "✓";
        confirmPasswordFeedback.className = "input-feedback success-feedback";
        confirmPasswordValid = true;
      }
      updateButtonState();
    });

    currentPasswordInput.addEventListener("blur", function () {
      const currentPass = currentPasswordInput.value.trim();
      if (currentPass === "") {
        currentPasswordFeedback.textContent = "Preencha a senha atual.";
        currentPasswordFeedback.className = "input-feedback error-feedback";
        currentPasswordValid = false;
        updateButtonState();
        return;
      }
      currentPasswordFeedback.textContent = "Verificando...";
      currentPasswordFeedback.className = "input-feedback";
      fetch('{{ url_for("perfil.validar_senha") }}', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ current_password: currentPass }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (!data.valid) {
            currentPasswordFeedback.textContent = "Senha atual incorreta.";
            currentPasswordFeedback.className = "input-feedback error-feedback";
            currentPasswordValid = false;
          } else {
            currentPasswordFeedback.textContent = "✓";
            currentPasswordFeedback.className =
              "input-feedback success-feedback";
            currentPasswordValid = true;
          }
          updateButtonState();
        })
        .catch((error) => {
          console.error("Erro na validação da senha atual:", error);
          currentPasswordFeedback.textContent =
            "Erro ao validar senha. Tente novamente.";
          currentPasswordFeedback.className = "input-feedback error-feedback";
          currentPasswordValid = false;
          updateButtonState();
        });
    });

    openPasswordModal.addEventListener("click", () => {
      console.log("Abrindo modal de alterar senha");
      passwordModal.style.display = "flex";
      passwordModal.classList.add("show");
      clearAllFeedbacks();
      passwordForm.reset();
      modalAtualizarBtn.disabled = true;
    });

    passwordModalClose.addEventListener("click", () => {
      passwordModal.classList.remove("show");
      setTimeout(() => {
        passwordModal.style.display = "none";
        passwordForm.reset();
        clearAllFeedbacks();
        modalAtualizarBtn.disabled = true;
      }, 300);
    });

    window.addEventListener("click", function (event) {
      if (event.target === passwordModal) {
        passwordModal.classList.remove("show");
        setTimeout(() => {
          passwordModal.style.display = "none";
          passwordForm.reset();
          clearAllFeedbacks();
          modalAtualizarBtn.disabled = true;
        }, 300);
      }
    });

    // ----- Modal de Foto de Perfil e Manipulação de Imagem -----
    const photoModal = document.getElementById("photoModal");
    const photoContainer = document.getElementById("foto-perfil-container");
    const photoUploadInput = document.getElementById("photo-upload");
    const photoEditorArea = document.getElementById("photo-editor-area");
    const zoomSlider = document.getElementById("zoom-slider");
    const zoomInBtn = document.getElementById("zoom-in-btn");
    const zoomOutBtn = document.getElementById("zoom-out-btn");
    const savePhotoBtn = document.getElementById("save-photo-btn");
    const cancelBtn = document.getElementById("photo-modal-cancel");

    let currentImage = null;
    let imageChanged = false;
    let currentZoom = 100;
    let dragOffset = { x: 0, y: 0 };
    let dragStart = { x: 0, y: 0 };
    let isDragging = false;
    let cropper = null;

    // ----- Modal de Confirmação de Exclusão de Foto -----
    const confirmDeleteModal = document.getElementById("confirmDeleteModal");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");

    function showConfirmDeleteModal() {
      confirmDeleteModal.style.display = "flex";
      confirmDeleteModal.classList.add("show");
    }
    function closeConfirmDeleteModal() {
      confirmDeleteModal.classList.remove("show");
      setTimeout(() => {
        confirmDeleteModal.style.display = "none";
      }, 300);
    }
    function promptDeletePhoto() {
      showConfirmDeleteModal();
    }
    confirmDeleteBtn.addEventListener("click", function () {
      deleteProfilePhotoConfirmed();
      closeConfirmDeleteModal();
    });
    cancelDeleteBtn.addEventListener("click", function () {
      closeConfirmDeleteModal();
    });
    if (document.getElementById("delete-photo-btn")) {
      document
        .getElementById("delete-photo-btn")
        .addEventListener("click", promptDeletePhoto);
    }

    // Função de exclusão efetiva da foto
    function deleteProfilePhotoConfirmed() {
      let deleteFlag = document.querySelector('input[name="delete_photo"]');
      if (!deleteFlag) {
        deleteFlag = document.createElement("input");
        deleteFlag.type = "hidden";
        deleteFlag.name = "delete_photo";
        deleteFlag.value = "true";
        document.querySelector(".form-editar-perfil").appendChild(deleteFlag);
      }
      document.getElementById("cropped_image_data").value = "";
      while (photoEditorArea.firstChild) {
        photoEditorArea.removeChild(photoEditorArea.firstChild);
      }
      const placeholder = document.createElement("div");
      placeholder.id = "photo-editor-placeholder";
      placeholder.innerHTML =
        '<i class="fas fa-cloud-upload-alt"></i><p>Selecione uma imagem para carregar</p>';
      photoEditorArea.appendChild(placeholder);
      document.getElementById("photo-modal-title").textContent =
        "Adicionar Foto";
      const deleteBtn = document.getElementById("delete-photo-btn");
      if (deleteBtn) {
        const selectBtn = document.createElement("button");
        selectBtn.id = "select-photo-btn";
        selectBtn.className = "btn btn-secondary";
        selectBtn.innerHTML = '<i class="fas fa-upload"></i> Selecionar Imagem';
        selectBtn.addEventListener("click", function () {
          photoUploadInput.click();
        });
        deleteBtn.parentNode.replaceChild(selectBtn, deleteBtn);
      }
      fotoChanged = true;
      checkPerfilFormChanged();
    }

    // ----- Funções de Manipulação da Foto -----
    function openPhotoModal() {
      photoModal.style.display = "flex";
      photoModal.classList.add("show");
      if (document.getElementById("photo-editor-image") && !cropper) {
        initCropper();
      }
    }

    function closePhotoModal() {
      photoModal.classList.remove("show");
      setTimeout(() => {
        photoModal.style.display = "none";
        if (
          imageChanged &&
          !document.getElementById("cropped_image_data").value
        ) {
          resetPhotoEditor();
        }
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
      }, 300);
    }

    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.match("image.*")) {
        alert("Por favor selecione apenas imagens.");
        return;
      }
      const reader = new FileReader();
      reader.onload = function (event) {
        while (photoEditorArea.firstChild) {
          photoEditorArea.removeChild(photoEditorArea.firstChild);
        }
        const img = document.createElement("img");
        img.id = "photo-editor-image";
        img.src = event.target.result;
        photoEditorArea.appendChild(img);
        img.onload = function () {
          initCropper();
          imageChanged = true;
          const selectBtn = document.getElementById("select-photo-btn");
          if (selectBtn) {
            selectBtn.innerHTML =
              '<i class="fas fa-upload"></i> Alterar Imagem';
          }
        };
      };
      reader.readAsDataURL(file);
    }

    function initCropper() {
      const image = document.getElementById("photo-editor-image");
      if (!image) return;
      if (typeof Cropper !== "undefined") {
        if (cropper) {
          cropper.destroy();
        }
        cropper = new Cropper(image, {
          aspectRatio: 1,
          viewMode: 1,
          dragMode: "move",
          autoCropArea: 1,
          restore: false,
          guides: false,
          center: true,
          highlight: false,
          cropBoxMovable: false,
          cropBoxResizable: false,
          toggleDragModeOnDblclick: false,
          ready: function () {
            savePhotoBtn.disabled = false;
          },
        });
      } else {
        enableBasicDragAndZoom(image);
        savePhotoBtn.disabled = false;
      }
    }

    function enableBasicDragAndZoom(image) {
      currentImage = image;
      image.addEventListener("mousedown", startDrag);
      image.addEventListener("mousemove", drag);
      image.addEventListener("mouseup", endDrag);
      image.addEventListener("mouseleave", endDrag);
      photoEditorArea.addEventListener("wheel", handleWheel);
      centerImage(image);
    }

    function startDrag(e) {
      e.preventDefault();
      isDragging = true;
      dragStart.x = e.clientX;
      dragStart.y = e.clientY;
    }

    function drag(e) {
      if (!isDragging) return;
      e.preventDefault();
      const dx = e.clientX - dragStart.x;
      const dy = e.clientY - dragStart.y;
      dragOffset.x += dx;
      dragOffset.y += dy;
      dragStart.x = e.clientX;
      dragStart.y = e.clientY;
      applyTransformation();
      savePhotoBtn.disabled = false;
    }

    function endDrag() {
      isDragging = false;
    }

    function handleWheel(e) {
      e.preventDefault();
      if (e.deltaY < 0) {
        currentZoom += 5;
      } else {
        currentZoom -= 5;
      }
      currentZoom = Math.max(100, Math.min(300, currentZoom));
      zoomSlider.value = currentZoom;
      applyTransformation();
      savePhotoBtn.disabled = false;
    }

    function handleZoomChange() {
      currentZoom = parseInt(zoomSlider.value);
      applyTransformation();
      savePhotoBtn.disabled = false;
    }

    function applyTransformation() {
      if (!currentImage) return;
      const scale = currentZoom / 100;
      currentImage.style.transform = `translate(${dragOffset.x}px, ${dragOffset.y}px) scale(${scale})`;
    }

    function centerImage(image) {
      dragOffset = { x: 0, y: 0 };
      currentZoom = 100;
      zoomSlider.value = currentZoom;
      image.style.transform = "translate(0, 0) scale(1)";
    }

    function savePhoto() {
      let imageData = "";
      if (cropper) {
        const canvas = cropper.getCroppedCanvas({
          width: 300,
          height: 300,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: "high",
        });
        if (!canvas) {
          alert("Erro ao processar a imagem. Por favor, tente novamente.");
          return;
        }
        imageData = canvas.toDataURL("image/jpeg");
        document.getElementById("cropped_image_data").value = imageData;
        updateProfilePreview(imageData);
      } else if (currentImage) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 300;
        canvas.height = 300;
        const scale = currentZoom / 100;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.scale(scale, scale);
        ctx.translate(dragOffset.x / scale, dragOffset.y / scale);
        ctx.drawImage(
          currentImage,
          -currentImage.width / 2,
          -currentImage.height / 2,
          currentImage.width,
          currentImage.height
        );
        ctx.restore();
        imageData = canvas.toDataURL("image/jpeg");
        document.getElementById("cropped_image_data").value = imageData;
        updateProfilePreview(imageData);
      }
      // Submete o formulário automaticamente – o backend decide se é inclusão ou exclusão da foto.
      document.querySelector(".form-editar-perfil").submit();
      closePhotoModal();
    }

    function updateProfilePreview(imageData) {
      const placeholder = document.getElementById("profile-placeholder");
      if (placeholder) {
        placeholder.remove();
      }
      let previewImg = document.getElementById("current-profile-photo");
      if (!previewImg) {
        previewImg = document.createElement("img");
        previewImg.id = "current-profile-photo";
        previewImg.className = "perfil-foto-preview";
        previewImg.alt = "Foto de Perfil";
        photoContainer.appendChild(previewImg);
      }
      previewImg.src = imageData;
    }

    function resetPhotoEditor() {
      while (photoEditorArea.firstChild) {
        photoEditorArea.removeChild(photoEditorArea.firstChild);
      }
      currentImage = null;
      imageChanged = false;
      currentZoom = 100;
      dragOffset = { x: 0, y: 0 };
      if (!document.getElementById("photo-editor-placeholder")) {
        const placeholder = document.createElement("div");
        placeholder.id = "photo-editor-placeholder";
        placeholder.innerHTML =
          '<i class="fas fa-cloud-upload-alt"></i><p>Selecione uma imagem para carregar</p>';
        photoEditorArea.appendChild(placeholder);
      }
      savePhotoBtn.disabled = true;
    }

    // ----- Eventos dos Elementos de Foto -----
    photoContainer.addEventListener("click", openPhotoModal);
    if (document.getElementById("select-photo-btn")) {
      document
        .getElementById("select-photo-btn")
        .addEventListener("click", function () {
          photoUploadInput.click();
        });
    }
    if (document.getElementById("delete-photo-btn")) {
      document
        .getElementById("delete-photo-btn")
        .addEventListener("click", promptDeletePhoto);
    }
    photoUploadInput.addEventListener("change", handleImageUpload);
    savePhotoBtn.addEventListener("click", savePhoto);
    cancelBtn.addEventListener("click", closePhotoModal);
    zoomSlider.addEventListener("input", handleZoomChange);
    zoomInBtn.addEventListener("click", () => {
      zoomSlider.value = parseInt(zoomSlider.value) + 10;
      handleZoomChange();
    });
    zoomOutBtn.addEventListener("click", () => {
      zoomSlider.value = parseInt(zoomSlider.value) - 10;
      handleZoomChange();
    });
    window.addEventListener("click", function (event) {
      if (event.target === photoModal) {
        closePhotoModal();
      }
    });
  });
</script>

{% endblock %}
