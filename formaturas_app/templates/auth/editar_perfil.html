<div class="perfil-wrapper"></div>
{% extends 'base.html' %} {% block content %}
<!-- Cabeçalho -->
<h2>Editar Perfil</h2>

<!-- Formulário para editar dados do perfil -->
<form method="post" enctype="multipart/form-data" class="form-editar-perfil">
  <!-- Foto de Perfil e Tag de Acesso -->
  <div class="perfil-upload-container">
    <label for="foto_perfil" class="perfil-foto-label">
      {% if usuario.foto_perfil %}
      <img
        src="{{ url_for('static', filename=usuario.foto_perfil) }}"
        alt="Foto de Perfil"
        class="perfil-foto-preview"
      />
      {% else %}
      <div class="perfil-foto-placeholder">Selecionar Foto</div>
      {% endif %}
    </label>
    <span class="perfil-access-tag {{ usuario.papel.value|lower }}">
      {{ usuario.papel.value }}
    </span>

    <input
      type="file"
      name="foto_perfil"
      id="foto_perfil"
      class="perfil-file-input"
      accept="image/*"
    />
  </div>

  <!-- Campos de texto: Apenas Nome e Email (email somente leitura) -->
  <div class="form-group">
    <label for="nome">Nome:</label>
    <input
      type="text"
      name="nome"
      id="nome"
      class="form-editar-perfil-input"
      value="{{ usuario.nome }}"
      required
    />
  </div>

  <div class="form-group">
    <label for="email">Email (não editável)</label>
    <div
      class="input-readonly-wrapper"
      title="Este email é fixo e não pode ser alterado."
    >
      <input
        type="email"
        name="email"
        id="email"
        class="form-editar-perfil-input readonly-input"
        value="{{ usuario.email }}"
        required
        readonly
      />
      <span class="icone-cadeado" aria-hidden="true">&#128274;</span>
    </div>
  </div>

  <!-- Botões -->
  <div class="form-group form-btns">
    <button type="submit" class="btn editar-perfil-btn-save" disabled>
      Atualizar Perfil
    </button>
    <button id="openPasswordModal" type="button" class="btn">
      Alterar Senha
    </button>
  </div>
</form>

<!-- Modal para Alteração de Senha -->
<div id="passwordModal" class="modal-overlay">
  <div class="modal-content">
    <h2>Alterar Senha</h2>
    <form
      method="post"
      action="{{ url_for('perfil.alterar_senha') }}"
      id="passwordForm"
    >
      <div class="form-group">
        <label for="current_password">Senha Atual:</label>
        <input
          type="password"
          name="current_password"
          id="current_password"
          required
        />
        <div class="input-feedback" id="currentPasswordFeedback"></div>
      </div>
      <div class="form-group">
        <label for="new_password">Nova Senha:</label>
        <input type="password" name="new_password" id="new_password" required />
        <div class="input-feedback" id="newPasswordFeedback"></div>
      </div>
      <div class="form-group">
        <label for="confirm_password">Confirmar Nova Senha:</label>
        <input
          type="password"
          name="confirm_password"
          id="confirm_password"
          required
        />
        <div class="input-feedback" id="confirmPasswordFeedback"></div>
      </div>
      <div class="password-requirements">
        <p>A senha deve conter:</p>
        <ul>
          <li id="req-length">Mínimo de 6 caracteres</li>
          <li id="req-letter">Pelo menos uma letra</li>
          <li id="req-number">Pelo menos um número</li>
        </ul>
      </div>
      <div class="modal-button-group">
        <button type="button" id="passwordModalClose" class="btn btn-voltar">
          Cancelar
        </button>
        <button
          type="submit"
          id="modalAtualizarBtn"
          class="btn cadastro-parente-btn-save"
          disabled
        >
          Atualizar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    /* --- Lógica para o Formulário de Editar Perfil --- */
    const editarPerfilBtn = document.querySelector(".editar-perfil-btn-save");
    const nomeInput = document.getElementById("nome");
    const emailInput = document.getElementById("email");
    const fotoInput = document.getElementById("foto_perfil");

    // Guarda os valores iniciais para comparação
    const initialNome = nomeInput.value;
    const initialEmail = emailInput.value;
    let fotoChanged = false;

    editarPerfilBtn.disabled = true;

    function checkPerfilFormChanged() {
      // Como o campo email é readonly, a comparação fica apenas com o nome e a foto
      if (nomeInput.value !== initialNome || fotoChanged) {
        editarPerfilBtn.disabled = false;
      } else {
        editarPerfilBtn.disabled = true;
      }
    }

    nomeInput.addEventListener("input", checkPerfilFormChanged);
    fotoInput.addEventListener("change", function () {
      fotoChanged = true;
      checkPerfilFormChanged();
    });

    /* --- Lógica para o Modal de Alteração de Senha --- */
    const openPasswordModal = document.getElementById("openPasswordModal");
    const passwordModal = document.getElementById("passwordModal");
    const passwordModalClose = document.getElementById("passwordModalClose");
    const passwordForm = document.getElementById("passwordForm");
    const currentPasswordInput = document.getElementById("current_password");
    const newPasswordInput = document.getElementById("new_password");
    const confirmPasswordInput = document.getElementById("confirm_password");
    const modalAtualizarBtn = document.getElementById("modalAtualizarBtn");

    // Seletores para os elementos de feedback específicos
    const currentPasswordFeedback = document.getElementById(
      "currentPasswordFeedback"
    );
    const newPasswordFeedback = document.getElementById("newPasswordFeedback");
    const confirmPasswordFeedback = document.getElementById(
      "confirmPasswordFeedback"
    );

    // Seletores para os requisitos de senha
    const reqLength = document.getElementById("req-length");
    const reqLetter = document.getElementById("req-letter");
    const reqNumber = document.getElementById("req-number");

    // Estado global da validação
    let currentPasswordValid = false;
    let newPasswordValid = false;
    let confirmPasswordValid = false;

    modalAtualizarBtn.disabled = true;

    // Função para limpar todos os feedbacks
    function clearAllFeedbacks() {
      currentPasswordFeedback.textContent = "";
      currentPasswordFeedback.className = "input-feedback";

      newPasswordFeedback.textContent = "";
      newPasswordFeedback.className = "input-feedback";

      confirmPasswordFeedback.textContent = "";
      confirmPasswordFeedback.className = "input-feedback";

      // Resetar requisitos de senha
      reqLength.className = "";
      reqLetter.className = "";
      reqNumber.className = "";

      // Resetar estado de validação
      currentPasswordValid = false;
      newPasswordValid = false;
      confirmPasswordValid = false;
    }

    // Função para verificar os requisitos da senha
    function checkPasswordRequirements(password) {
      const requirements = {
        length: password.length >= 6,
        letter: /[a-zA-Z]/.test(password),
        number: /[0-9]/.test(password),
      };

      // Atualiza visualmente os requisitos
      reqLength.className = requirements.length ? "requirement-met" : "";
      reqLetter.className = requirements.letter ? "requirement-met" : "";
      reqNumber.className = requirements.number ? "requirement-met" : "";

      return requirements.length && requirements.letter && requirements.number;
    }

    // Função para atualizar o estado do botão com base nas validações
    function updateButtonState() {
      modalAtualizarBtn.disabled = !(
        currentPasswordValid &&
        newPasswordValid &&
        confirmPasswordValid
      );
    }

    // Adiciona eventos de validação para cada campo
    currentPasswordInput.addEventListener("input", function () {
      const currentPass = currentPasswordInput.value.trim();

      if (currentPass === "") {
        currentPasswordFeedback.textContent = "Preencha a senha atual.";
        currentPasswordFeedback.className = "input-feedback error-feedback";
        currentPasswordValid = false;
      } else if (currentPasswordValid) {
        // Manter o estado válido se já foi validado pelo servidor
        currentPasswordFeedback.textContent = "✓";
        currentPasswordFeedback.className = "input-feedback success-feedback";
      } else {
        currentPasswordFeedback.textContent = "";
        currentPasswordFeedback.className = "input-feedback";
        // O estado permanece falso até a validação do servidor
      }

      updateButtonState();
    });

    newPasswordInput.addEventListener("input", function () {
      const newPass = newPasswordInput.value.trim();
      const currentPass = currentPasswordInput.value.trim();

      // Verifica os requisitos enquanto digita
      const requirementsMet = checkPasswordRequirements(newPass);

      if (newPass === "") {
        newPasswordFeedback.textContent = "Informe uma nova senha.";
        newPasswordFeedback.className = "input-feedback error-feedback";
        newPasswordValid = false;
      } else if (!requirementsMet) {
        newPasswordFeedback.textContent = "A senha não atende aos requisitos.";
        newPasswordFeedback.className = "input-feedback error-feedback";
        newPasswordValid = false;
      } else if (newPass === currentPass && currentPass !== "") {
        newPasswordFeedback.textContent =
          "A nova senha deve ser diferente da atual.";
        newPasswordFeedback.className = "input-feedback error-feedback";
        newPasswordValid = false;
      } else {
        newPasswordFeedback.textContent = "✓";
        newPasswordFeedback.className = "input-feedback success-feedback";
        newPasswordValid = true;
      }

      // Se a senha nova mudou, precisamos validar a confirmação novamente
      const confirmPass = confirmPasswordInput.value.trim();
      if (confirmPass !== "") {
        if (confirmPass === newPass && requirementsMet) {
          confirmPasswordFeedback.textContent = "✓";
          confirmPasswordFeedback.className = "input-feedback success-feedback";
          confirmPasswordValid = true;
        } else {
          confirmPasswordFeedback.textContent = "As senhas não conferem.";
          confirmPasswordFeedback.className = "input-feedback error-feedback";
          confirmPasswordValid = false;
        }
      }

      updateButtonState();
    });

    confirmPasswordInput.addEventListener("input", function () {
      const confirmPass = confirmPasswordInput.value.trim();
      const newPass = newPasswordInput.value.trim();
      const requirementsMet = checkPasswordRequirements(newPass);

      if (confirmPass === "") {
        confirmPasswordFeedback.textContent = "Confirme a nova senha.";
        confirmPasswordFeedback.className = "input-feedback error-feedback";
        confirmPasswordValid = false;
      } else if (confirmPass !== newPass) {
        confirmPasswordFeedback.textContent = "As senhas não conferem.";
        confirmPasswordFeedback.className = "input-feedback error-feedback";
        confirmPasswordValid = false;
      } else if (confirmPass === newPass && requirementsMet) {
        confirmPasswordFeedback.textContent = "✓";
        confirmPasswordFeedback.className = "input-feedback success-feedback";
        confirmPasswordValid = true;
      }

      updateButtonState();
    });

    // Validação da senha atual com o servidor
    currentPasswordInput.addEventListener("blur", function () {
      const currentPass = currentPasswordInput.value.trim();
      if (currentPass === "") {
        currentPasswordFeedback.textContent = "Preencha a senha atual.";
        currentPasswordFeedback.className = "input-feedback error-feedback";
        currentPasswordValid = false;
        updateButtonState();
        return;
      }

      // Mostra feedback de verificação em andamento
      currentPasswordFeedback.textContent = "Verificando...";
      currentPasswordFeedback.className = "input-feedback";

      fetch('{{ url_for("perfil.validar_senha") }}', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ current_password: currentPass }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (!data.valid) {
            currentPasswordFeedback.textContent = "Senha atual incorreta.";
            currentPasswordFeedback.className = "input-feedback error-feedback";
            currentPasswordValid = false;
          } else {
            currentPasswordFeedback.textContent = "✓";
            currentPasswordFeedback.className =
              "input-feedback success-feedback";
            currentPasswordValid = true;
          }
          updateButtonState();
        })
        .catch((error) => {
          console.error("Erro na validação da senha atual:", error);
          currentPasswordFeedback.textContent =
            "Erro ao validar senha. Tente novamente.";
          currentPasswordFeedback.className = "input-feedback error-feedback";
          currentPasswordValid = false;
          updateButtonState();
        });
    });

    // Abre o modal de alteração de senha
    openPasswordModal.addEventListener("click", () => {
      passwordModal.style.display = "flex";
      passwordModal.classList.add("show");
      clearAllFeedbacks();
      passwordForm.reset();
      modalAtualizarBtn.disabled = true;
    });

    // Fecha o modal ao clicar em "Cancelar" ou fora do conteúdo
    passwordModalClose.addEventListener("click", () => {
      passwordModal.classList.remove("show");
      setTimeout(() => {
        passwordModal.style.display = "none";
        passwordForm.reset();
        clearAllFeedbacks();
        modalAtualizarBtn.disabled = true;
      }, 300);
    });

    window.addEventListener("click", function (event) {
      if (event.target === passwordModal) {
        passwordModal.classList.remove("show");
        setTimeout(() => {
          passwordModal.style.display = "none";
          passwordForm.reset();
          clearAllFeedbacks();
          modalAtualizarBtn.disabled = true;
        }, 300);
      }
    });
  });
</script>
{% endblock %}
