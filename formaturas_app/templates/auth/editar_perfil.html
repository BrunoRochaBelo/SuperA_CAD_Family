<div class="perfil-wrapper"></div>
{% extends 'base.html' %} {% block content %}
<!-- Adicione um wrapper com margem extra para empurrar o conteúdo pra baixo -->

<h2>Editar Perfil</h2>

<!-- Formulário para editar dados do perfil -->
<form method="post" enctype="multipart/form-data" class="form-editar-perfil">
  <!-- Foto de Perfil no topo -->
  <div class="perfil-upload-container">
    <label for="foto_perfil" class="perfil-foto-label">
      {% if usuario.foto_perfil %}
      <img
        src="{{ url_for('static', filename=usuario.foto_perfil) }}"
        alt="Foto de Perfil"
        class="perfil-foto-preview"
      />
      {% else %}
      <div class="perfil-foto-placeholder">Selecionar Foto</div>
      {% endif %}
    </label>
    <span class="perfil-access-tag">{{ usuario.papel.value }}</span>
    <input
      type="file"
      name="foto_perfil"
      id="foto_perfil"
      class="perfil-file-input"
      accept="image/*"
    />
  </div>

  <!-- Campos de texto -->
  <div class="form-group">
    <label for="nome">Nome Completo:</label>
    <input
      type="text"
      name="nome"
      id="nome"
      class="form-editar-perfil-input"
      value="{{ usuario.nome }}"
      required
    />
  </div>

  <div class="form-group">
    <label for="username">Nome de Usuário:</label>
    <input
      type="text"
      name="username"
      id="username"
      class="form-editar-perfil-input"
      value="{{ usuario.username or '' }}"
      required
    />
  </div>

  <!-- Botões -->
  <div class="form-group">
    <button type="submit" class="btn editar-perfil-btn-save" disabled>
      Atualizar Perfil
    </button>
    <!-- Botão para abrir o modal de alteração de senha -->
    <button id="openPasswordModal" type="button" class="btn">
      Alterar Senha
    </button>
  </div>
</form>

<!-- FIM DO WRAPPER -->

<!-- Modal para alteração de senha (fora do form) -->
<div id="passwordModal" class="modal-overlay">
  <div class="modal-content">
    <h2>Alterar Senha</h2>
    <form method="post" action="{{ url_for('perfil.alterar_senha') }}">
      <div class="form-group">
        <label for="current_password">Senha Atual:</label>
        <input
          type="password"
          name="current_password"
          id="current_password"
          required
        />
      </div>
      <div class="form-group">
        <label for="new_password">Nova Senha:</label>
        <input type="password" name="new_password" id="new_password" required />
      </div>
      <div class="form-group">
        <label for="confirm_password">Confirmar Nova Senha:</label>
        <input
          type="password"
          name="confirm_password"
          id="confirm_password"
          required
        />
      </div>
      <!-- Feedback para o formulário de senha -->
      <div id="passwordFeedback" style="color: red; font-size: 0.9rem"></div>
      <div class="modal-button-group">
        <button type="button" id="passwordModalClose" class="btn btn-voltar">
          Cancelar
        </button>
        <button type="submit" class="btn cadastro-parente-btn-save">
          Atualizar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    /* --- Lógica para o Formulário de Editar Perfil --- */
    const editarPerfilBtn = document.querySelector(".editar-perfil-btn-save");
    const nomeInput = document.getElementById("nome");
    const usernameInput = document.getElementById("username");
    const fotoInput = document.getElementById("foto_perfil");

    // Guarda os valores iniciais para comparação
    const initialNome = nomeInput.value;
    const initialUsername = usernameInput.value;
    let fotoChanged = false;

    // Botão desabilitado inicialmente
    editarPerfilBtn.disabled = true;

    function checkPerfilFormChanged() {
      if (
        nomeInput.value !== initialNome ||
        usernameInput.value !== initialUsername ||
        fotoChanged
      ) {
        editarPerfilBtn.disabled = false;
      } else {
        editarPerfilBtn.disabled = true;
      }
    }

    nomeInput.addEventListener("input", checkPerfilFormChanged);
    usernameInput.addEventListener("input", checkPerfilFormChanged);
    fotoInput.addEventListener("change", function () {
      fotoChanged = true;
      checkPerfilFormChanged();
    });

    /* --- Lógica para o Modal de Alteração de Senha --- */
    const openPasswordModal = document.getElementById("openPasswordModal");
    const passwordModal = document.getElementById("passwordModal");
    const passwordModalClose = document.getElementById("passwordModalClose");
    const passwordForm = passwordModal.querySelector("form");
    const currentPasswordInput = document.getElementById("current_password");
    const newPasswordInput = document.getElementById("new_password");
    const confirmPasswordInput = document.getElementById("confirm_password");
    const modalAtualizarBtn = passwordForm.querySelector(
      'button[type="submit"]'
    );
    const passwordFeedback = document.getElementById("passwordFeedback");

    // Inicializa o botão de atualizar senha como desabilitado
    modalAtualizarBtn.disabled = true;

    function validatePasswordForm() {
      let valid = true;
      let errorMessage = "";

      // Verifica se os três campos estão preenchidos
      if (
        currentPasswordInput.value.trim() === "" ||
        newPasswordInput.value.trim() === "" ||
        confirmPasswordInput.value.trim() === ""
      ) {
        valid = false;
      }

      // Verifica se as novas senhas conferem
      if (newPasswordInput.value !== confirmPasswordInput.value) {
        valid = false;
        errorMessage = "As novas senhas não conferem.";
      }

      // Verifica se a nova senha é diferente da senha atual
      if (
        currentPasswordInput.value.trim() !== "" &&
        newPasswordInput.value === currentPasswordInput.value
      ) {
        valid = false;
        errorMessage = "A nova senha deve ser diferente da atual.";
      }

      passwordFeedback.textContent = errorMessage;
      modalAtualizarBtn.disabled = !valid;
    }

    [newPasswordInput, confirmPasswordInput].forEach((input) => {
      input.addEventListener("input", validatePasswordForm);
    });

    // Validação assíncrona da senha atual via AJAX ao sair do campo
    currentPasswordInput.addEventListener("blur", function () {
      const currentPass = currentPasswordInput.value.trim();
      if (currentPass === "") return;
      fetch('{{ url_for("perfil.validar_senha") }}', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ current_password: currentPass }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (!data.valid) {
            passwordFeedback.textContent = "Senha atual incorreta.";
            modalAtualizarBtn.disabled = true;
          } else {
            passwordFeedback.textContent = "";
            validatePasswordForm();
          }
        })
        .catch((error) => {
          console.error("Erro na validação da senha atual:", error);
        });
    });

    // Abre o modal de alteração de senha
    if (openPasswordModal) {
      openPasswordModal.addEventListener("click", () => {
        passwordModal.style.display = "flex";
        passwordModal.classList.add("show");
      });
    }

    // Fecha o modal ao clicar no botão Cancelar
    if (passwordModalClose) {
      passwordModalClose.addEventListener("click", () => {
        passwordModal.classList.remove("show");
        setTimeout(() => {
          passwordModal.style.display = "none";
        }, 300);
      });
    }

    // Fecha o modal se clicar fora do conteúdo
    window.addEventListener("click", function (event) {
      if (event.target === passwordModal) {
        passwordModal.classList.remove("show");
        setTimeout(() => {
          passwordModal.style.display = "none";
        }, 300);
      }
    });
  });
</script>
{% endblock %}
