<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}Formaturas App{% endblock %}</title>
    <link
      rel="icon"
      href="{{ url_for('static', filename='img/favicon.svg') }}"
      type="image/svg+xml"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <!-- CSS customizado -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />

    <!-- Tippy.js CSS para tooltips -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="navbar-left">
          {% if current_user.is_authenticated %}
          <a
            class="navbar-profile {% if active_page=='editar_perfil' %}active{% endif %}"
            id="profileIcon"
            data-tippy-content="Meu Perfil"
          >
            {% if current_user.foto_perfil %}
            <img
              src="{{ url_for('static', filename=current_user.foto_perfil) }}"
              alt="Foto de Perfil"
            />
            {% else %}
            <div class="navbar-profile-initial">
              {{ current_user.nome[0].upper() }}
            </div>
            {% endif %}

            <span
              class="profile-label {% if active_page=='editar_perfil' %}active{% endif %}"
            >
              Você
            </span>
          </a>

          {% endif %}
        </div>
        <div class="navbar-center">
          <!-- Home -->
          <a
            href="{{ url_for('home.index', active_page='home') }}"
            class="{% if active_page=='home' %}active{% endif %}"
            data-tippy-content="Home"
          >
            <span class="nav-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M3 12l9-9 9 9"></path>
                <path d="M9 21V9h6v12"></path>
              </svg>
            </span>
            <span class="nav-text">Home</span>
          </a>
          <!-- Turmas -->
          <a
            href="{{ url_for('turmas.index', active_page='turmas') }}"
            class="{% if active_page=='turmas' %}active{% endif %}"
            data-tippy-content="Turmas"
          >
            <span class="nav-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
              </svg>
            </span>
            <span class="nav-text">Turmas</span>
          </a>
          {% if current_user.is_authenticated and current_user.papel.value ==
          'ADM' %}
          <!-- Aba Equipe -->
          <a
            href="{{ url_for('equipe.index', active_page='equipe') }}"
            class="{% if active_page=='equipe' %}active{% endif %}"
            data-tippy-content="Equipe"
          >
            <span class="nav-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <!-- Cabeça central -->
                <circle cx="12" cy="6" r="3" />
                <!-- Corpo central -->
                <path d="M6 20v-2a6 6 0 0 1 12 0v2" />

                <!-- Cabeça esquerda -->
                <circle cx="5" cy="9" r="2" />
                <!-- Corpo esquerdo -->
                <path d="M2 20v-1a4 4 0 0 1 4-4" />

                <!-- Cabeça direita -->
                <circle cx="19" cy="9" r="2" />
                <!-- Corpo direito -->
                <path d="M22 20v-1a4 4 0 0 0-4-4" />
              </svg>
            </span>
            <span class="nav-text">Equipe</span>
          </a>

          <!-- Relatórios -->
          <a
            href="{{ url_for('relatorios.filtrar', active_page='relatorios') }}"
            class="{% if active_page=='relatorios' %}active{% endif %}"
            data-tippy-content="Relatório"
          >
            <span class="nav-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                ></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
            </span>
            <span class="nav-text">Relatório</span>
          </a>
          {% endif %}
        </div>
      </nav>
    </header>

    <main>
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div id="flash-messages">
        {% for category, msg in messages %}
        <div class="alert alert-{{ category|default('info') }}">
          <span class="alert-text">{{ msg }}</span>
          <button
            class="alert-close"
            onclick="this.parentElement.style.display='none';"
          >
            &times;
          </button>
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}

      <div class="container-floating">{% block content %}{% endblock %}</div>
    </main>

    <!-- Modal do Perfil -->
    <div id="profileModal" class="modal-overlay">
      <div class="profile-modal-content">
        <div class="profile-modal-header">
          <h2>Meu Perfil</h2>
        </div>

        <div class="profile-modal-body">
          {% if current_user.is_authenticated %}
          <div class="profile-user-avatar profile-animate">
            {% if current_user.foto_perfil %}
            <img
              src="{{ url_for('static', filename=current_user.foto_perfil) }}"
              alt="Foto de Perfil"
              class="profile-avatar-img"
            />
            {% else %}
            <div class="profile-avatar-text">
              {{ current_user.nome[0].upper() }}
            </div>
            {% endif %}
          </div>
          <div class="profile-access-section-tag profile-animate">
            <span
              class="profile-access-value-tag {{ current_user.papel.value|lower }}"
            >
              {{ current_user.papel.value }}
            </span>
          </div>
          <div class="profile-info-item profile-animate">
            <span class="profile-info-label">Nome:</span>
            <span class="profile-info-value">{{ current_user.nome }}</span>
          </div>

          <div class="profile-info-item profile-animate">
            <span class="profile-info-label">Email:</span>
            <span class="profile-info-value">{{ current_user.email }}</span>
          </div>

          <div class="profile-divider"></div>

          <!-- Grupo de botões: Editar Perfil e Encerrar Sessão -->
          <div class="profile-button-group profile-animate">
            <a
              href="{{ url_for('auth.logout') }}"
              class="profile-btn btn-voltar btn-icon-text"
            >
              <span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                  <polyline points="16 17 21 12 16 7"></polyline>
                  <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
              </span>
              Encerrar sessão
            </a>
            <a
              href="{{ url_for('perfil.editar_perfil') }}"
              class="profile-btn btn"
            >
              Editar Perfil
            </a>
          </div>

          {% else %}
          <p>Usuário não autenticado.</p>
          {% endif %}
        </div>

        <div class="profile-footer">
          <button type="button" id="modalCloseBtn" class="btn">Fechar</button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelector("main").classList.add("fade-in");

        // Gerenciamento de mensagens flash
        setTimeout(() => {
          const flashDiv = document.getElementById("flash-messages");
          if (flashDiv) {
            flashDiv.style.opacity = "0";
            setTimeout(() => (flashDiv.style.display = "none"), 500);
          }
        }, 5000);

        // Obter o caminho atual da URL
        const currentPath = window.location.pathname;
        // Elementos do perfil
        const profileIcon = document.getElementById("profileIcon");
        const profileModal = document.getElementById("profileModal");
        const modalCloseBtn = document.getElementById("modalCloseBtn");

        // Se estiver na rota /auth/editar_perfil, aplica o estilo imediatamente
        if (profileIcon && currentPath === "/auth/editar_perfil") {
          profileIcon.classList.add("active");
        }

        if (profileIcon) {
          profileIcon.addEventListener("click", () => {
            // Se estiver na página de editar perfil, não abre o modal; já está indicado
            if (currentPath === "/auth/editar_perfil") {
              console.log("Você já está na página de edição de perfil.");
            } else {
              // Abre o modal normalmente
              document.body.style.overflow = "hidden";
              profileModal.style.display = "flex";
              setTimeout(() => {
                profileModal.classList.add("show");
              }, 10);
            }
          });
        }

        // Manipuladores de fechamento do modal
        const closeModalHandlers = [modalCloseBtn];
        closeModalHandlers.forEach((element) => {
          if (element) {
            element.addEventListener("click", () => {
              closeProfileModal();
            });
          }
        });

        // Fechar clicando fora do modal
        window.addEventListener("click", function (event) {
          if (event.target === profileModal) {
            closeProfileModal();
          }
        });

        // Fechamento com tecla ESC
        document.addEventListener("keydown", function (event) {
          if (
            event.key === "Escape" &&
            profileModal.classList.contains("show")
          ) {
            closeProfileModal();
          }
        });

        function closeProfileModal() {
          profileModal.classList.remove("show");
          setTimeout(() => {
            profileModal.style.display = "none";
            document.body.style.overflow = "";
          }, 300);
        }

        // Inicialização de tooltips para os botões do modal
        if (typeof tippy !== "undefined") {
          tippy("[data-tippy-content]");
        }
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const forms = document.querySelectorAll("form");

        forms.forEach((form) => {
          const focusables = Array.from(
            form.querySelectorAll("input, select, textarea")
          ).filter(
            (el) =>
              !el.disabled && el.type !== "hidden" && el.offsetParent !== null
          ); // ignora escondidos

          focusables.forEach((el, index) => {
            el.addEventListener("keydown", (e) => {
              if (e.key === "Enter" && el.tagName !== "TEXTAREA") {
                e.preventDefault();
                const next = focusables[index + 1];
                if (next) {
                  next.focus();
                } else {
                  // Último campo: opcionalmente envia o form
                  form.requestSubmit(); // ou form.submit();
                }
              }
            });
          });
        });
      });
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>
